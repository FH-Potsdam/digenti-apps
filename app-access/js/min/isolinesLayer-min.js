function isolinesLayer(){function t(t,a){var s=t.geometry.coordinates,i=s[1]+","+s[0],r=app.config.apiBase+"/isoline/"+i+"/"+e.queryRanges,o=function(i){e.isolinesQueried++;for(var r=0;r<i.features.length;r++){var o=i.features[r],l=o.properties.range,n={type:"Feature",properties:{"marker-color":"#f00"},geometry:{type:"Point",coordinates:s}},p=turf.buffer(o,2e3,"meters");if(console.log(p),turf.inside(n,p)){o.properties.osm_id=t.properties.osm_id,o.properties.name=t.properties.name,e.isolinesGeoJSON.features.push(o);var c=e.svglayer.select('g[data-id="'+a+'"]').select(".isoline-group-vis");c.append("path").data([o]).classed("isoline",!0).classed("disabled",function(){return l!=e.range}).attr("data-range",l).attr("data-id",a)}}};$.ajax({dataType:"json",url:r,success:o,error:function(t){alert(t)}})}var e=this;this.isolinesQueried=0,this.active=!0,this.scaleFactor=0,this.lastView="",this.isolinesGeoJSON={type:"FeatureCollection",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[]},this.queryRanges="30",this.range=0,this.isolinesQueried=0,this.setActive=function(t){null===t?this.active=!this.active:this.active=t,this.svglayer.classed("disabled",!this.active)},this.setQueryRanges=function(t){this.queryRanges=t},this.setRange=function(t){this.range=t},this.toggleIsolines=function(){this.svglayer.selectAll(".isoline-group-vis path.isoline").classed("disabled",function(){var t=d3.select(this);return t.attr("data-range")!=e.range})},this.init=function(e,a){this.svglayer=e.append("g").attr("id","isolines"),this.setActive(!1),this.svglayer.selectAll("g").data(a.features).enter().append("g").attr("data-id",function(t){return t.properties.osm_id}).attr("class","isoline-group").each(function(){app.config.layoutdebug===!0&&d3.select(this).append("rect").attr("class","layoutdebug")}).append("g").attr("class","isoline-group-vis").each(function(e){t(e,e.properties.osm_id)})},this.calc=function(){if(isDefined(this.svglayer))if("smallmultiples"===app.view){var t=0,a=0,s=0,i=0;this.svglayer.selectAll(".isoline-group-vis").each(function(){var t=d3.select(this),e=t.node().getBBox().width,a=t.node().getBBox().height;a>i&&(i=a),e>s&&(s=e)});var r=app.layout.heightperelement/i,o=app.layout.widthperelement/s;e.scaleFactor=r,o<e.scaleFactor&&(e.scaleFactor=o),this.svglayer.selectAll(".isoline-group").each(function(s){var i=d3.select(this),r=s.geometry.coordinates;app.config.layoutdebug===!0&&i.selectAll(".layoutdebug").attr("width",app.layout.widthperelement).attr("height",app.layout.heightperelement);var o=app.layout.offsetLeft+t*(app.layout.gapX+app.layout.widthperelement);t++,t===app.layout.cols&&(t=0);var l=app.layout.offsetTop+a*(app.layout.gapY+app.layout.heightperelement);a++,a===app.layout.rows&&(a=0),i.attr("data-transformX",o).attr("data-transformY",l),i.selectAll(".isoline-group-vis").each(function(){var t=d3.select(this),a=d3.select(this).node().getBBox(),s=(-a.x+app.layout.widthperelement/e.scaleFactor/2-a.width/2)*e.scaleFactor,n=(-a.y+app.layout.heightperelement/e.scaleFactor/2-a.height/2)*e.scaleFactor;if(t.attr("data-transformX",s).attr("data-transformY",n),e.active){var p,c;0===a.width&&0===a.height?(p=s+o,c=n+l):(p=parseFloat(project(r).x*e.scaleFactor)+s+o,c=parseFloat(project(r).y*e.scaleFactor)+n+l),app.villagePositions[i.attr("data-id")]={},app.villagePositions[i.attr("data-id")].x=p,app.villagePositions[i.attr("data-id")].y=c}})})}else e.active&&(app.villagePositions=app.villagePositionsMap.slice())},this.update=function(t){this.calc(),this.render(t)},this.render=function(t){var a=d3.geo.transform({point:projectPoint}),s=d3.geo.path().projection(a);isDefined(this.svglayer)&&("smallmultiples"===app.view?e.lastView!==app.view&&(this.svglayer.selectAll(".isoline-group").transition().duration(t).style("opacity",1).attr("transform",function(){return"translate("+d3.select(this).attr("data-transformX")+","+d3.select(this).attr("data-transformY")+")"}),this.svglayer.selectAll(".isoline-group-vis").transition().duration(t).style("opacity",1).attr("transform",function(){return"translate("+d3.select(this).attr("data-transformX")+","+d3.select(this).attr("data-transformY")+") scale("+e.scaleFactor+")"})):e.lastView!==app.view&&(this.svglayer.selectAll(".isoline-group").transition().duration(t).style("opacity",1).attr("transform",""),this.svglayer.selectAll(".isoline-group-vis").transition().duration(t).attr("transform","")),this.svglayer.selectAll(".isoline").attr("d",s)),e.lastView=app.view}}
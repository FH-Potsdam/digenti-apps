function addLayer(e,t,i){app.layers[e]={},app.layers[e].active=t,app.layers[e].layer=new i}function init(){$.ajax({url:app.config.apiBase,type:"HEAD",error:function(){$(".spinner").remove(),$(".alert").html("Can't reach API under <i>"+app.config.apiBase+"</i>. It seems to be offline.<br>Please start the API and reload the app.")},success:function(){console.log("DIGENTI API is available and ready for use"),$.when($.getScript("js/routesLayer.js"),$.getScript("js/missingInfrastructureLayer.js"),$.getScript("js/isolinesLayer.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){addLayer("routesfromvalledupar",!1,routesLayer),addLayer("missinginfrastructure",!1,missingInfrastructureLayer),addLayer("isolines",!1,isolinesLayer),initRangeSlider(),d3.queue().defer(d3.json,"../../data/"+app.config.data.places).await(function(e,t){if(e)throw e;places_aoi=t,mapDraw(places_aoi)})})}})}function hideSplashScreen(){console.log("HIDE LOADER"),$("#loader").removeClass("show"),$("#loader").removeClass("displayed")}function mapDraw(e){mapboxgl.accessToken=app.config.accessToken;var t="dark"===app.config.theme?"mapbox://styles/jorditost/cj5jfd4p20i8o2rmah13d5u0o":"mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi";map=new mapboxgl.Map({container:"map",style:t,zoom:app.config.map.zoom,center:app.config.map.center}),map.dragRotate.disable(),map.touchZoomRotate.disableRotation(),map.keyboard.disable(),map.boxZoom.disable(),console.log("we are still here"),config.tabletop&&$(document).bind("contextmenu",function(e){e.preventDefault()}),$(document).keydown(function(e){e.ctrlKey!==!0||"61"!==e.which&&"107"!==e.which&&"173"!==e.which&&"109"!==e.which&&"187"!==e.which&&"189"!==e.which||e.preventDefault()}),$(window).bind("mousewheel DOMMouseScroll",function(e){e.ctrlKey===!0&&e.preventDefault()}),console.log("BEFORE EVENT HANDLING"),map.on("viewreset",update),map.on("moveend",update),map.on("move",update),map.on("load",hideSplashScreen),console.log("hide splash screen"),hideSplashScreen(),console.log("before d3 DRAW"),svg=d3.select(map.getCanvasContainer()).append("svg").attr("id","map-features"),lineFunction=d3.svg.line().x(function(e){return project(e).x}).y(function(e){return project(e).y}).interpolate("linear");for(var i in app.layers)app.layers.hasOwnProperty(i)&&app.layers[i].layer.init(svg,e);labelLayer=svg.append("g").attr("id","label-layer"),labelLayer.selectAll("g").data(places_aoi.features).enter().append("g").attr("class","").attr("data-id",function(e){return e.properties.osm_id}).each(function(){var e=d3.select(this),t=e.append("text");t.append("tspan").attr("class","title").text(function(e){return e.properties.name}).style("opactity",0).attr("class","title").attr("x","-4").attr("y","45"),t.append("tspan").attr("class","desc").text(" m to street").attr("x","-4").attr("y","45").attr("dy","1.2em"),app.config.layoutdebug===!0&&e.append("rect").attr("class","layoutdebug")}),settlementPointLayer=svg.append("g").attr("id","settlement-point-layer"),settlementPointLayer.selectAll("circle").data(places_aoi.features).enter().append("circle").attr("class",function(e){return"village "+e.properties.type}).attr("r",function(e){return app.config.circleRadius+getPopulationFactor(e.properties)}).on("click",function(e){onSettlementClicked(e)}).attr("data-id",function(e){return e.properties.osm_id}).each(function(e){app.villagePositionsMap[e.properties.osm_id]={},app.villagePositionsMap[e.properties.osm_id].x=project(e.geometry.coordinates).x,app.villagePositionsMap[e.properties.osm_id].y=project(e.geometry.coordinates).y}),settlementPointLayer.moveToFront(),update(0),initMapLayersControl()}function initMapLayersControl(){app.config.showIsolines=$("#show-isolines").is(":checked"),app.config.showLanding=$("#show-landing").is(":checked"),app.config.showIsolines||($layers.find(".graphic-isoline").addClass("hide"),d3.selectAll("g#isolines").classed("hide",!0),$infoBox.find("#reachability").hide()),$("#show-isolines").click(function(){$(this).is(":checked")?($layers.find(".graphic-isoline").removeClass("hide"),d3.selectAll("g#isolines").classed("hide",!1),$infoBox.find("#reachability").show()):($layers.find(".graphic-isoline").addClass("hide"),d3.selectAll("g#isolines").classed("hide",!0),$infoBox.find("#reachability").hide())}),app.config.showIsolines||($layers.find(".graphic-landing").addClass("hide"),map.setLayoutProperty("landing-place","visibility","none")),$("#show-landing").click(function(){$(this).is(":checked")?($layers.find(".graphic-landing").removeClass("hide"),map.setLayoutProperty("landing-place","visibility","visible")):($layers.find(".graphic-landing").addClass("hide"),map.setLayoutProperty("landing-place","visibility","none"))})}function update(e){null!==e&&"object"==typeof e?e=0:isNaN(e)&&(e=app.config.transitionTime),app.layout=calculateLayoutVars(),settlementPointLayer.selectAll("circle").each(function(e){app.villagePositionsMap[e.properties.osm_id]={},app.villagePositionsMap[e.properties.osm_id].x=project(e.geometry.coordinates).x,app.villagePositionsMap[e.properties.osm_id].y=project(e.geometry.coordinates).y});for(var t in app.layers)app.layers.hasOwnProperty(t)&&app.layers[t].layer.calc();if("smallmultiples"!==app.view){console.log("VILLAGE POSITIONS");var i=app.villagePositionsMap;app.villagePositions=app.villagePositionsMap}updateSettlementPointLayer(e);for(t in app.layers)app.layers.hasOwnProperty(t)&&app.layers[t].layer.render(e);renderLabels(e)}function toggleViews(){"smallmultiples"===app.view?triggerMapView():triggerSmallMultiplesView()}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),showMap(),enableMapInteraction(),$legend.removeClass("hide"),app.view="",update(app.config.transitionTime)}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!1),hideMap(),disableMapInteraction(),$legend.addClass("hide"),$layers.addClass("hide"),app.view="smallmultiples",update(app.config.transitionTime)}function reorderSmallMultiples(e){app.orderby=e,d3.selectAll(".orderby").classed("active",!1),d3.selectAll("."+app.orderby).classed("active",!0),update(app.config.transitionTime)}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}function enableMapInteraction(){map.doubleClickZoom.enable(),map.scrollZoom.enable(),map.dragPan.enable(),d3.select("#map").classed("disabled",!1)}function disableMapInteraction(){map.doubleClickZoom.disable(),map.scrollZoom.disable(),map.dragPan.disable(),d3.select("#map").classed("disabled",!0)}function showMap(){d3.selectAll(".mapboxgl-canvas").classed("hidden",!1),d3.selectAll(".mapboxgl-canvas").classed("hidden",!1)}function hideMap(){d3.selectAll(".mapboxgl-canvas").classed("hidden",!0),d3.selectAll(".mapboxgl-canvas").classed("hidden",!0)}function updateSettlementPointLayer(e){settlementPointLayer.selectAll("circle").each(function(){var t=d3.select(this),i=t.attr("data-id");isDefined(app.villagePositions[i])&&t.transition().duration(e).attr("cx",app.villagePositions[i].x).attr("cy",app.villagePositions[i].y)})}function renderLabels(e){"smallmultiples"===app.view?labelLayer.transition().duration(e).style("opacity",1):labelLayer.transition().duration(e).style("opacity",0),repositionLabels(e)}function repositionLabels(e){labelLayer.selectAll("g").each(function(){var t=d3.select(this),i=t.attr("data-id");t.transition().duration(e).style("opacity",1).attr("transform",function(){return"translate("+app.villagePositions[i].x+","+app.villagePositions[i].y+")"})})}function calculateLayoutVars(){var e={};e.w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e.h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),e.rows=7,e.cols=6,$nav.length>0?e.navWidth=Math.round($nav.width()):$("#nav").length>0?e.navWidth=Math.round($("#nav").width()):$pageTitle.length>0?e.navWidth=Math.round($pageTitle.outerWidth(!0)):e.navWidth=Math.round($("#page-title").outerWidth(!0)),0==$legend.length&&($legend=$("#legend")),e.legendWidth=Math.round($legend.width()),0==$layers.length&&($layers=$("#layers")),e.layersWidth=Math.round($layers.width()),0==$infoBox.length&&($infoBox=$("#info"));var t=$infoBox.hasClass("show");return e.infoHeight=Math.round(parseInt($infoBox.height(),10)),t||($infoBox.css("bottom",-e.infoHeight+"px"),e.infoHeight=0),e.offsetLeft=e.navWidth+60,e.offsetTop=Math.round(.01*e.w),e.offsetBottom=Math.round(e.offsetTop+e.infoHeight),e.offsetRight=0,e.gapX=Math.round(.008*e.w),e.gapY=Math.round(e.gapX),e.widthperelement=Math.round((e.w-e.offsetLeft-e.offsetRight-(e.cols-1)*e.gapX)/e.cols),e.heightperelement=Math.round((e.h-e.offsetTop-e.offsetBottom-(e.rows-1)*e.gapY)/e.rows),e}function project(e){return map.project(new mapboxgl.LngLat(+e[0],+e[1]))}function projectPoint(e,t){var i=map.project(new mapboxgl.LngLat(e,t));this.stream.point(i.x,i.y)}function isDefined(e){return"undefined"!=typeof e&&null!==e}function initRangeSlider(){$rangeSlider=$("#range__slider"),$rangeText=$("#range__text");var e=parseInt($rangeSlider.val());$rangeText.html(e+" min"),app.layers.isolines.layer.setRange(e);for(var t=parseInt($rangeSlider.attr("min")),i=parseInt($rangeSlider.attr("max")),a=parseInt($rangeSlider.attr("step")),n=1+(i-t)/a,s=[],o=0;o<n;o++)s.push(t+o*a);app.layers.isolines.layer.setQueryRanges(s.toString())}function rangeSliderInput(){var e=parseInt($rangeSlider.val());$rangeText.html(e+" min"),app.layers.isolines.layer.setRange(e),app.layers.isolines.layer.toggleIsolines()}function showInfoBox(e){$infoBox||($infoBox=$("#info"));var t=e.properties.type;"Vda-Resguardo Caño Padilla"!=e.properties.name&&"Resguardo indígena La Laguna"!=e.properties.name||(t="indigenous reserve"),$infoBox.find("#basic-info .title").text(e.properties.name),$infoBox.find("#basic-info .details").text(String(t).capitalize()+", "+getPlacePopulation(e.properties)+" inhabitants"),drawMicrovis(e),$layers.removeClass("hide");var i=app.layers.isolines.layer.hasIsolines(e.properties.osm_id);i?($infoBox.find("#reachability .isolines-wrap").removeClass("hide"),$infoBox.find("#reachability .no-reachable").addClass("hide")):($infoBox.find("#reachability .isolines-wrap").addClass("hide"),$infoBox.find("#reachability .no-reachable").removeClass("hide")),$infoBox.addClass("show"),$infoBox.find(".close").one("click",function(){hideInfoBox(),hideFOS("route"),hideFOS("missing"),hideLandingSites("place"),deactivateSelectedSettlements(),$layers.addClass("hide")})}function hideInfoBox(e){$infoBox||($infoBox=$("#info")),$infoBox.removeClass("show")}function drawMicrovis(e){d3.selectAll("#microvis svg").remove();var t="<span>"+activeRouteObj.route.distance/1e3+" km,</span> <span class='time'>"+parseInt(activeRouteObj.route.travelTime/60)+" min</span>";if(activeMissingObj){var i=activeMissingObj.missing.properties.distance/1e3;i=Math.round(10*i)/10,t+=" till the end of the road | <span class='no-reachable'>"+i+" km</span> from road to settlement"}else t+=" to the settlement";$infoBox.find("#microvis-route-stats").html(t),drawElevationProfile(e,activeRouteObj,activeMissingObj)}function drawElevationProfile(e,t,i){function a(){currentLine.style("visibility","visible"),currentCircle.style("visibility","visible"),currentText.style("visibility","visible")}function n(){var e=d3.mouse(this),t=e[0],i=Math.round(xElev.invert(t));i<0&&(i=0),i>=c.length&&(i=c.length-1);var a=10*i/1e3,n=Math.round(c[i].properties.elevation);currentLine.attr("x1",xElev(i)).attr("y1",yElev(0)).attr("x2",xElev(i)).attr("y2",yElev(n)),currentCircle.attr("cx",xElev(i)).attr("cy",yElev(n)),currentTextPlace.attr("x",xElev(i)-2).attr("y",yElev(n)-22).text(function(){return"Dist: "+a+" km"}),currentTextElev.attr("x",xElev(i)-2).attr("y",yElev(n)-12).text(function(){return"Elev: "+n+" m"})}function s(e,t){currentLine.style("visibility","hidden"),currentCircle.style("visibility","hidden"),currentText.style("visibility","hidden")}function o(){microvisWidth=parseInt(d3.select("#info #microvis").style("width"),10),microvisHeight=parseInt(d3.select("#info .content").style("height"),10)-80,graphWidth=microvisWidth-margin.left-margin.right,graphHeight=microvisHeight-margin.top-margin.bottom,xElev.range([0,graphWidth]),yElev.range([graphHeight,0]),svgElev.attr("width",microvisWidth),svgElev.attr("height",microvisHeight),svgElev.select(".profile.route").attr("d",profilePath(l)),svgElev.select(".profile.missing").attr("d",profilePath(r)).attr("transform","translate("+xElev(l.length)+",0)"),svgElev.select("rect.hit").attr("width",graphWidth).attr("height",graphHeight),yElevAxis.tickSize(-graphWidth),svgElev.select(".x.axis").attr("transform","translate("+margin.left+","+(graphHeight+margin.top)+")").call(xElevAxis),svgElev.select(".y.axis").call(yElevAxis)}microvisWidth=parseInt(d3.select("#info #microvis").style("width"),10),microvisHeight=parseInt(d3.select("#info .content").style("height"),10)-80,graphWidth=microvisWidth-margin.left-margin.right,graphHeight=microvisHeight-margin.top-margin.bottom;var l=t.route_sliced.features,r=i?i.missing_sliced.features:[],c=l.concat(r);xElev=d3.scale.linear().range([0,graphWidth]).domain([0,maxDistance/10]),yElev=d3.scale.linear().range([graphHeight,0]).domain([0,maxElev]),yElevAxis=d3.svg.axis().ticks(4).tickFormat(function(e){return e+"m"}).tickSize(-graphWidth).tickPadding(5).scale(yElev).orient("left"),xElevAxis=d3.svg.axis().ticks(5).tickFormat(function(e){return 10*e/1e3+"km"}).tickPadding(10).scale(xElev).orient("bottom"),profilePath=d3.svg.line().interpolate("basis").x(function(e,t){return xElev(t)}).y(function(e,t){return yElev(e.properties.elevation)}),svgElev=d3.select("#microvis-route-profile").append("svg").attr("class","elevation").attr("width",microvisWidth).attr("height",microvisHeight),svgElev.append("g").attr("class","axis y").attr("transform","translate("+margin.left+","+margin.top+")").call(yElevAxis),svgElev.append("g").attr("class","axis x").attr("transform","translate("+margin.left+","+(graphHeight+margin.top)+")").call(xElevAxis).selectAll("text").style("text-anchor","end"),gProfile=svgElev.append("g").attr("class","profile-group").attr("transform","translate("+margin.left+","+margin.top+")"),gProfile.append("path").attr("class","profile route").attr("d",profilePath(l)),gProfile.append("path").attr("class","profile missing").attr("d",profilePath(r)).attr("transform","translate("+xElev(l.length)+",0)"),currentLine=gProfile.append("line").attr("class","current").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",graphHeight).style("visibility","hidden"),currentCircle=gProfile.append("circle").attr("class","current").attr("cx",0).attr("cy",0).attr("r",2).style("visibility","hidden"),currentText=gProfile.append("g").attr("class","current-text").style("visibility","hidden"),currentTextPlace=currentText.append("text"),currentTextElev=currentText.append("text").attr("class","sec"),gProfile.append("rect").attr("class","hit").attr("width",graphWidth).attr("height",graphHeight).on("mouseenter",a).on("mousemove",n).on("mouseout",s),d3.select(window).on("resize",o)}function drawRoute(e,t){svgRoute=d3.select("#microvis-route").append("svg").attr("class","route"),svgRoute.append("g").append("path").attr("data-id",e.properties.osm_id).attr("class","line route").attr("d",lineFunction(t)),resizeRoute()}function resizeRoute(){var e=svgRoute.select("g"),t=e.node().getBBox(),i=app.layout.microvisWidth/t.width,a=-t.x*i,n=-t.y*i;svgRoute.attr("width",app.layout.microvisWidth).attr("height",i*t.height),e.attr("transform"," translate("+a+","+n+") scale("+i+")")}function loadFOSByLineString(e,t){console.log("load FOS by GeoJSON LineString"),console.log(app.config.apiBase+"/fos/route/"),console.log(e);var i={feature:JSON.stringify(e),buffer:config.threat.buffer,intersect:config.threat.intersect};$.ajax({method:"POST",url:app.config.apiBase+"/fos/route/",data:JSON.stringify(i),contentType:"application/json; charset=utf-8",dataType:"json",success:function(e){console.log("FOS loaded"),console.log(e),drawFOS(e,t)},error:function(e){console.log(JSON.stringify(e))}})}function hideFOS(e){map.getSource("fos-"+e)&&(map.setLayoutProperty("fos1-"+e,"visibility","none"),map.setLayoutProperty("fos2-"+e,"visibility","none"),map.setLayoutProperty("fos3-"+e,"visibility","none"))}function drawFOS(e,t){map.getSource("fos-"+t)?map.getSource("fos-"+t).setData(e):map.addSource("fos-"+t,{type:"geojson",data:e}),map.getLayer("fos1-"+t)?(map.setLayoutProperty("fos1-"+t,"visibility","visible"),map.setLayoutProperty("fos2-"+t,"visibility","visible"),map.setLayoutProperty("fos3-"+t,"visibility","visible")):(map.addLayer({id:"fos3-"+t,type:"fill",source:"fos-"+t,filter:["==","fos",3],paint:{"fill-color":"#F7D57F","fill-opacity":config.threat.opacity,"fill-antialias":!1}}),map.addLayer({id:"fos2-"+t,type:"fill",source:"fos-"+t,filter:["==","fos",2],paint:{"fill-color":"#F5A623","fill-opacity":config.threat.opacity,"fill-antialias":!1}}),map.addLayer({id:"fos1-"+t,type:"fill",source:"fos-"+t,filter:["==","fos",1],paint:{"fill-color":"#ED5D5A","fill-opacity":config.threat.opacity,"fill-antialias":!1}}))}function loadLandingSites(e,t){console.log("load Landing Sites by Lat/Lon"),console.log(app.config.apiBase+"/specialareas/"+config.landing.ndviThres+"/"+config.landing.gradientThres+"/point/"+e.geometry.coordinates[1]+","+e.geometry.coordinates[0]+"/"+config.landing.buffer),$.ajax({method:"GET",url:app.config.apiBase+"/specialareas/"+config.landing.ndviThres+"/"+config.landing.gradientThres+"/point/"+e.geometry.coordinates[1]+","+e.geometry.coordinates[0]+"/"+config.landing.buffer,contentType:"application/json; charset=utf-8",dataType:"json",success:function(e){console.log("Landing sites loaded"),console.log(e),drawLandingSites(e,t)},error:function(e){console.log(JSON.stringify(e))}})}function hideLandingSites(e){map.getSource("landing-"+e)&&map.setLayoutProperty("landing-"+e,"visibility","none")}function drawLandingSites(e,t){if(map.getSource("landing-"+t)?map.getSource("landing-"+t).setData(e):map.addSource("landing-"+t,{type:"geojson",data:e}),map.getLayer("landing-"+t)){var i=$("#show-landing").is(":checked");map.setLayoutProperty("landing-"+t,"visibility",i?"visible":"none")}else map.addLayer({id:"landing-"+t,type:"fill",source:"landing-"+t,layout:{visibility:"none"},paint:{"fill-color":"#3cd9d9","fill-opacity":config.landing.opacity}})}function onSettlementClicked(e){if($.inArray(e.properties.osm_id,app.selectedSettlements)>=0)d3.selectAll(".village[data-id='"+e.properties.osm_id+"']").classed("selected",!1),d3.selectAll("g[data-id='"+e.properties.osm_id+"']").classed("selected-settlement",!1),app.selectedSettlements.remove(e.properties.osm_id),0==app.selectedSettlements.length&&svg.classed("detail",!1);else{app.config.multipleSettlements||deactivateSelectedSettlements(),d3.selectAll(".village[data-id='"+e.properties.osm_id+"']").classed("selected",!0),d3.selectAll("g[data-id='"+e.properties.osm_id+"']").classed("selected-settlement",!0);var t=d3.select("#routesfromvalledupar g[data-id='"+e.properties.osm_id+"']");t.moveToFront(),app.selectedSettlements.push(e.properties.osm_id),svg.classed("detail",!0),activeRouteObj=getElementByPlaceID(e.properties.osm_id,routesJSON.routes),activeMissingObj=getElementByPlaceID(e.properties.osm_id,routesJSON.missing),activeSettlementGeoJSON=getGeoJSONFeatureByPlaceID(e.properties.osm_id,places_aoi),activeRouteGeoJSON=getGeoJSONFeatureByPlaceID(e.properties.osm_id,routesGeoJSON),config.threat.show&&(hideFOS("route"),loadFOSByLineString(activeRouteGeoJSON,"route"),config.threat.showMissing&&(hideFOS("missing"),activeMissingObj&&activeMissingObj.missing&&loadFOSByLineString(activeMissingObj.missing,"missing"))),showInfoBox(e),$("#show-isolines").unbind("click").click(function(){console.log("click click"),$(this).is(":checked")?($layers.find(".graphic-isoline").removeClass("hide"),d3.selectAll("g#isolines").classed("hide",!1),$infoBox.find("#reachability").show()):($layers.find(".graphic-isoline").addClass("hide"),d3.selectAll("g#isolines").classed("hide",!0),$infoBox.find("#reachability").hide())}),config.landing.show&&(hideLandingSites("place"),loadLandingSites(e,"place"),$("#show-landing").unbind("click").click(function(){var e="landing-place",t=map.getLayoutProperty(e,"visibility");"visible"===t?(map.setLayoutProperty(e,"visibility","none"),this.className="",$layers.find(".graphic-landing").addClass("hide")):(this.className="active",map.setLayoutProperty(e,"visibility","visible"),$layers.find(".graphic-landing").removeClass("hide"))}))}if(app.selectedSettlements.length>0){for(var i in app.layers)app.layers.hasOwnProperty(i)&&(app.layers[i].active=!1,d3.selectAll(".mode#"+i).classed("active",app.layers[i].active));app.layout=calculateLayoutVars(),update(app.config.transitionTime)}else{for(var i in app.layers)"routesfromvalledupar"!==i&&"missinginfrastructure"!==i||app.layers.hasOwnProperty(i)&&(app.layers[i].active=!0,d3.selectAll(".mode#"+i).classed("active",app.layers[i].active));app.layout=calculateLayoutVars(),hideInfoBox(e),hideFOS("route"),hideFOS("missing"),hideLandingSites("place"),$layers.addClass("hide"),update(app.config.transitionTime)}}function deactivateSelectedSettlements(){if(0==app.selectedSettlements.length)return!1;var e=app.selectedSettlements[0];d3.selectAll(".village[data-id='"+e+"']").classed("selected",!1),d3.selectAll("g[data-id='"+e+"']").classed("selected-settlement",!1),app.selectedSettlements.remove(e),0==app.selectedSettlements.length&&svg.classed("detail",!1)}var app={};app.view="",app.mode="",app.orderby="distance",app.layers=[],app.villagePositions=[],app.villagePositionsMap=[],app.selectedSettlements=[];var smpos=[],map,svg,settlementPointLayer,lineFunction,places_aoi,routesGeoJSON=turf.featureCollection([]),routesJSON={};routesJSON.routes=[],routesJSON.missing=[];var activeSettlementGeoJSON,activeRouteGeoJSON,activeRouteObj,activeMissingObj,$body,$nav,$pageTitle,$legend,$layers,$infoBox,$rangeSlider,$rangeText;$(document).ready(function(){$body=$("body"),$nav=$("#nav"),$pageTitle=$("#page-title"),$legend=$("#legend"),$layers=$("#layers"),$infoBox=$("#info"),app.layout=calculateLayoutVars(),$.when($.getScript("config.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){app.config=config,console.log("#################################################"),console.log("##  DIGENTI APP started. Loading requirements… ##"),console.log("#################################################"),console.log(" "),"undefined"==typeof app.config.theme&&(app.config.theme="light"),$body.addClass(app.config.theme),app.config.tabletop&&$body.addClass("tabletop"),"undefined"!=typeof app.config.noUI&&app.config.noUI===!0&&$body.addClass("no-ui"),console.log("Current config follows in next line:"),console.log(app),init()})});var maxElev=2600;maxDistance=6e4;var svgElev,gProfile,xElev,yElev,xElevAxis,yElevAxis,profilePath,margin={top:30,right:60,bottom:30,left:34},microvisWidth,microvisHeight,graphWidth,graphHeight,currentLine,currentCircle,currentText,currentTextPlace,currentTextElev,svgRoute;d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},Array.prototype.remove=function(){for(var e,t=arguments,i=t.length,a;i&&this.length;)for(e=t[--i];(a=this.indexOf(e))!==-1;)this.splice(a,1);return this};
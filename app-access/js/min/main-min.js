function addLayer(e,t,a){app.layers[e]={},app.layers[e].active=t,app.layers[e].layer=new a}function init(){$.ajax({url:app.config.apiBase,type:"HEAD",error:function(){$(".spinner").remove(),$(".alert").html("Can't reach API under <i>"+app.config.apiBase+"</i>. It seems to be offline.<br>Please start the API and reload the app.")},success:function(){$.when($.getScript("js/routesLayer.js"),$.getScript("js/missingInfrastructureLayer.js"),$.getScript("js/isolinesLayer.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){addLayer("routesfromvalledupar",!1,routesLayer),addLayer("missinginfrastructure",!1,missingInfrastructureLayer),addLayer("isolines",!1,isolinesLayer),initRangeSlider(),d3.queue().defer(d3.json,"../../data/places_aoi.json").defer(d3.json,"../../data/street_points_aoi.json").await(function(e,t,a){if(e)throw e;places_aoi=t,street_points_aoi=a,mapDraw(places_aoi)})})}})}function hideSplashScreen(){$("#loader").removeClass("show"),setTimeout(function(){$("#loader").removeClass("displayed")},1e3)}function mapDraw(e){function t(e){"DIGENTI"===e?map.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"DIGENTI-Light"===e?map.setStyle("mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi"):"DIGENTI-Dark"===e?map.setStyle("mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t"):"fos-outdoor"===e?map.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):map.setStyle("mapbox://styles/mapbox/"+e)}mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A";var a="dark"===app.config.theme?"mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t":"mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi";map=new mapboxgl.Map({container:"map",style:a,zoom:11.4,center:[-73.12,10.41]}),map.dragRotate.disable(),map.touchZoomRotate.disableRotation(),map.keyboard.disable(),map.boxZoom.disable(),config.tabletop,$(document).keydown(function(e){e.ctrlKey!==!0||"61"!==e.which&&"107"!==e.which&&"173"!==e.which&&"109"!==e.which&&"187"!==e.which&&"189"!==e.which||e.preventDefault()}),$(window).bind("mousewheel DOMMouseScroll",function(e){e.ctrlKey===!0&&e.preventDefault()}),map.addControl(new mapboxgl.Navigation),map.on("viewreset",update),map.on("moveend",update),map.on("move",update),map.on("load",hideSplashScreen),svg=d3.select(map.getCanvasContainer()).append("svg").attr("class","map-features"),lineFunction=d3.svg.line().x(function(e){return project(e).x}).y(function(e){return project(e).y}).interpolate("linear"),labelLayer=svg.append("g").attr("id","label-layer"),labelLayer.selectAll("g").data(places_aoi.features).enter().append("g").attr("class","").attr("data-id",function(e){return e.properties.osm_id}).each(function(){var e=d3.select(this);e.append("text").append("tspan").text(function(e){return e.properties.name}).style("opactity",0).attr("class","title").attr("y","132"),app.config.layoutdebug===!0&&e.append("rect").attr("class","layoutdebug")}),settlementPointLayer=svg.append("g").attr("id","settlement-point-layer"),settlementPointLayer.selectAll("circle").data(places_aoi.features).enter().append("circle").attr("class","village").attr("r",app.config.circleRadius).on("click",function(e){clickCallback(e)}).attr("data-id",function(e){return e.properties.osm_id}).each(function(e){app.villagePositionsMap[e.properties.osm_id]={},app.villagePositionsMap[e.properties.osm_id].x=project(e.geometry.coordinates).x,app.villagePositionsMap[e.properties.osm_id].y=project(e.geometry.coordinates).y});for(var o in app.layers)app.layers.hasOwnProperty(o)&&app.layers[o].layer.init(svg,e);$("#basemap_select").change(function(){t($(this).val())}),settlementPointLayer.moveToFront(),update(0)}function update(e){null!==e&&"object"==typeof e?e=0:isNaN(e)&&(e=app.config.transitionTime),app.layout=calculateLayoutVars(),settlementPointLayer.selectAll("circle").each(function(e){app.villagePositionsMap[e.properties.osm_id]={},app.villagePositionsMap[e.properties.osm_id].x=project(e.geometry.coordinates).x,app.villagePositionsMap[e.properties.osm_id].y=project(e.geometry.coordinates).y});for(var t in app.layers)app.layers.hasOwnProperty(t)&&app.layers[t].layer.calc();"smallmultiples"!==app.view&&(app.villagePositions=app.villagePositionsMap.slice()),updateSettlementPointLayer(e);for(t in app.layers)app.layers.hasOwnProperty(t)&&app.layers[t].layer.render(e);renderLabels(e)}function toggleViews(){"smallmultiples"===app.view?triggerMapView():triggerSmallMultiplesView()}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),showMap(),enableMapInteraction(),app.view="",update(app.config.transitionTime)}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!1),hideMap(),disableMapInteraction(),app.view="smallmultiples",update(app.config.transitionTime)}function reorderSmallMultiples(e){app.orderby=e,d3.selectAll(".orderby").classed("active",!1),d3.selectAll("."+app.orderby).classed("active",!0),update(app.config.transitionTime)}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}function enableMapInteraction(){map.doubleClickZoom.enable(),map.scrollZoom.enable(),map.dragPan.enable(),d3.select("#map").classed("disabled",!1)}function disableMapInteraction(){map.doubleClickZoom.disable(),map.scrollZoom.disable(),map.dragPan.disable(),d3.select("#map").classed("disabled",!0)}function showMap(){d3.selectAll(".mapboxgl-canvas").classed("hidden",!1),d3.selectAll(".mapboxgl-canvas").classed("hidden",!1)}function hideMap(){d3.selectAll(".mapboxgl-canvas").classed("hidden",!0),d3.selectAll(".mapboxgl-canvas").classed("hidden",!0)}function updateSettlementPointLayer(e){settlementPointLayer.selectAll("circle").each(function(){var t=d3.select(this),a=t.attr("data-id");isDefined(app.villagePositions[a])&&t.transition().duration(e).attr("cx",app.villagePositions[a].x).attr("cy",app.villagePositions[a].y)})}function renderLabels(e){"smallmultiples"===app.view?labelLayer.transition().duration(e).style("opacity",1):labelLayer.transition().duration(e).style("opacity",0)}function repositionLabels(e){labelLayer.selectAll("g").each(function(){var t=d3.select(this),a=t.attr("data-id");t.transition().duration(e).style("opacity",1).attr("transform",function(){return"translate("+smpos[a].x+","+smpos[a].y+")"})})}function calculateLayoutVars(){var e={};return e.w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e.h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),e.rows=7,e.cols=6,$nav?e.navWidth=Math.round($nav.width()):e.navWidth=Math.round($("#nav").width()),$infoBox?(e.infoWidth=Math.round(parseInt($infoBox.width())+parseInt($infoBox.css("right"))),e.microvisWidth=parseInt($infoBox.find(".content").width())):(e.infoWidth=Math.round(parseInt($("#info").width())+parseInt($("#info").css("right"))),e.microvisWidth=parseInt($("#info .content").width())),e.offsetLeft=e.navWidth+50,e.offsetTop=Math.round(.01*e.w),e.offsetBottom=Math.round(e.offsetTop),e.offsetRight=Math.round(e.offsetTop+e.infoWidth),e.gapX=Math.round(.008*e.w),e.gapY=Math.round(e.gapX),e.widthperelement=Math.round((e.w-e.offsetLeft-e.offsetRight-(e.cols-1)*e.gapX)/e.cols),e.heightperelement=Math.round((e.h-e.offsetTop-e.offsetBottom-(e.rows-1)*e.gapY)/e.rows),e}function project(e){return map.project(new mapboxgl.LngLat(+e[0],+e[1]))}function projectPoint(e,t){var a=map.project(new mapboxgl.LngLat(e,t));this.stream.point(a.x,a.y)}function isDefined(e){return"undefined"!=typeof e&&null!==e}function initRangeSlider(){$rangeSlider=$("#range__slider"),$rangeText=$("#range__text");var e=parseInt($rangeSlider.val());$rangeText.html(e+" min"),app.layers.isolines.layer.setRange(e);for(var t=parseInt($rangeSlider.attr("min")),a=parseInt($rangeSlider.attr("max")),o=parseInt($rangeSlider.attr("step")),i=1+(a-t)/o,n=[],r=0;r<i;r++)n.push(t+r*o);app.layers.isolines.layer.setQueryRanges(n.toString())}function rangeSliderInput(){var e=parseInt($rangeSlider.val());$rangeText.html(e+" min"),app.layers.isolines.layer.setRange(e),app.layers.isolines.layer.toggleIsolines()}function getElementByPlaceID(e,t){var a=$.grep(t,function(t,a){return t.id===e});return a.length>0?a[0]:null}function showInfoBox(e){$infoBox||($infoBox=$("#info")),$infoBox.find(".title").text(e.properties.name),$infoBox.find(".type").next("dd").text(String(e.properties.type).capitalize()),$infoBox.find(".population").next("dd").text(getPlacePopulation(e.properties)),drawMicroVis(e),$infoBox.addClass("show"),$infoBox.find(".close").one("click",function(){$infoBox.removeClass("show"),deactivateSelectedSettlements()})}function hideInfoBox(e){$infoBox||($infoBox=$("#info")),$infoBox.removeClass("show")}function drawMicroVis(e){function t(){resizeRoute(e,routeData),resizeElevationProfile(e,routeData)}app.layout.microvisHeight=100,d3.selectAll("#microvis svg").remove(),routeJSON=getElementByPlaceID(e.properties.osm_id,routesJSON.routes),routeData=routeJSON.route.geometry.coordinates,$infoBox.find("#microvis-route-stats").empty().append(routeJSON.route.distance/1e3+" km | "+parseInt(routeJSON.route.travelTime/60)+" min"),drawElevationProfile(e,routeData),d3.select(window).on("resize",t)}function drawElevationProfile(e,t){function a(){var e=d3.mouse(this),a=e[0],o=Math.round(xElev.invert(a)),i=t[o][2];console.log("i: "+o+", elev: "+i),r.attr("x1",xElev(o)).attr("y1",yElev(0)).attr("x2",xElev(o)).attr("y2",yElev(i)),l.attr("cx",xElev(o)).attr("cy",yElev(i)),s.attr("x",xElev(o)-10).attr("y",yElev(i)-15).text(function(){return i+"m"})}function o(e,t){r.attr("x1",-10).attr("y1",0).attr("x2",-10).attr("y2",app.layout.microvisHeight),l.attr("cx",-10).attr("cy",-10),s.attr("x",-10).attr("y",-15).text("")}xElev=d3.scale.linear().range([0,app.layout.microvisWidth]),yElev=d3.scale.linear().range([app.layout.microvisHeight,0]).domain([0,maxElev]),console.log("length: "+t.length+", min: "+d3.min(t,function(e){return e[2]})+", max: "+d3.max(t,function(e){return e[2]})),xElev.domain([0,t.length]);var i=d3.scale.linear().domain([0,maxElev]).range(["#2FB8E9","yellow"]);svgElev=d3.select("#microvis-elev").append("svg").attr("class","elevation").attr("width",app.layout.microvisWidth).attr("height",app.layout.microvisHeight).append("g");var n=svgElev.selectAll("line").data(t);n.enter().append("line").attr("class","line").attr("x1",function(e,t){return xElev(t)}).attr("y1",function(e){return yElev(0)}).attr("x2",function(e,t){return xElev(t)}).attr("y2",function(e){var t=e[2];return yElev(t)}).style("stroke",function(e,t){var a=e[2];return i(a)}),svgElev.selectAll(".follow").data(t).enter().append("line").attr("class","follow").attr("x1",function(e,t){var a=t>0?t-1:0;return xElev(a)}).attr("y1",function(e,a){var o=a>0?a-1:0,i=t[o][2];return yElev(i)}).attr("x2",function(e,t){return xElev(t)}).attr("y2",function(e,a){var o=t[a][2];return yElev(o)}).style("stroke",function(e,t){var a=e[2];return i(a)});var r=svgElev.append("line").attr("class","current").attr("x1",-10).attr("y1",0).attr("x2",-10).attr("y2",app.layout.microvisHeight),l=svgElev.append("circle").attr("class","current").attr("cx",-10).attr("cy",-10).attr("r",2),s=svgElev.append("text").attr("class","current-text");svgElev.on("mousemove",a),svgElev.on("mouseout",o),resizeElevationProfile()}function resizeElevationProfile(){svgElev.attr("width",app.layout.microvisWidth),xElev.range([0,app.layout.microvisWidth])}function drawRoute(e,t){svgRoute=d3.select("#microvis-route").append("svg").attr("class","route"),svgRoute.append("g").append("path").attr("data-id",e.properties.osm_id).attr("class","line route").attr("d",lineFunction(t)),resizeRoute()}function resizeRoute(){var e=svgRoute.select("g"),t=e.node().getBBox(),a=app.layout.microvisWidth/t.width,o=-t.x*a,i=-t.y*a;svgRoute.attr("width",app.layout.microvisWidth).attr("height",a*t.height),e.attr("transform"," translate("+o+","+i+") scale("+a+")")}function clickCallback(e){if($.inArray(e.properties.osm_id,app.selectedSettlements)>=0?(d3.selectAll(".village[data-id='"+e.properties.osm_id+"']").classed("selected",!1),d3.selectAll("g[data-id='"+e.properties.osm_id+"']").classed("selectedSettlement",!1),app.selectedSettlements.remove(e.properties.osm_id)):(app.config.multipleSettlements||deactivateSelectedSettlements(),d3.selectAll(".village[data-id='"+e.properties.osm_id+"']").classed("selected",!0),d3.selectAll("g[data-id='"+e.properties.osm_id+"']").classed("selectedSettlement",!0),app.selectedSettlements.push(e.properties.osm_id),showInfoBox(e)),app.selectedSettlements.length>0){for(var t in app.layers)app.layers.hasOwnProperty(t)&&(app.layers[t].active=!1,d3.selectAll(".mode#"+t).classed("active",app.layers[t].active));app.layout=calculateLayoutVars(),update(app.config.transitionTime)}else{for(var t in app.layers)"routesfromvalledupar"!==t&&"missinginfrastructure"!==t||app.layers.hasOwnProperty(t)&&(app.layers[t].active=!0,d3.selectAll(".mode#"+t).classed("active",app.layers[t].active));app.layout=calculateLayoutVars(),hideInfoBox(e),update(app.config.transitionTime)}}function deactivateSelectedSettlements(){if(0==app.selectedSettlements.length)return!1;console.log("remove remove");var e=app.selectedSettlements[0];d3.selectAll(".village[data-id='"+e+"']").classed("selected",!1),d3.selectAll("g[data-id='"+e+"']").classed("selectedSettlement",!1),app.selectedSettlements.remove(e)}var map,svg,settlementPointLayer,lineFunction,places_aoi,street_points_aoi,routesArray=[],routesJSON={};routesJSON.routes=[];var app={};app.view="",app.mode="",app.orderby="size",app.layers=[],app.villagePositions=[],app.villagePositionsMap=[],app.selectedSettlements=[];var smpos=[],$body,$nav,$infoBox,$rangeSlider,$rangeText;$(document).ready(function(){$body=$("body"),$nav=$("#nav"),$infoBox=$("#info"),app.layout=calculateLayoutVars(),$.when($.getScript("config.js"),$.Deferred(function(e){$(e.resolve)})).done(function(){app.config=config,console.log("#################################################"),console.log("##  DIGENTI APP started. Loading requirements… ##"),console.log("#################################################"),console.log(" "),"undefined"==typeof app.config.theme&&(app.config.theme="light"),$body.addClass(app.config.theme),app.config.tabletop&&$body.addClass("tabletop"),console.log("Current config follows in next line:"),console.log(app),init()})}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var routeJSON,routeData,svgElev,gElev,lineElev,areaElev,xElev,yElev,maxElev=1e3,svgRoute;Array.prototype.remove=function(){for(var e,t=arguments,a=t.length,o;a&&this.length;)for(e=t[--a];(o=this.indexOf(e))!==-1;)this.splice(o,1);return this};
function routesLayer(){var t=this;this.svglayer="",this.routes_geo=[],this.active=!0,this.scaleFactor=0,this.lastView="",this.setActive=function(t){null===t?this.active=!this.active:this.active=t,this.svglayer.classed("disabled",!this.active)},this.init=function(e,a){function s(e,s,i){function r(e){for(var a=generateUniqueID(),s=0;s<e.properties.id.length;s++)t.svglayer.selectAll("g[data-id='"+e.properties.id[s]+"']").append("path").attr("data-id",a).attr("class","route").attr("data-stroke-width",.4*e.properties.importancescore+1).attr("stroke-width",.4*e.properties.importancescore+1).attr("d",lineFunction(e.geometry.coordinates)),t.routes_geo[a]=e.geometry.coordinates}function o(t){var e={init:function(){return this.id=i,this.geometry=t.geometry,this.travelTime=t.properties.travelTime,this.distance=t.properties.distance,this.path=lineFunction(this.geometry.coordinates),this}}.init(),s={};s.id=i,s.route=e,routesJSON.routes.push(s),routesJSON.routes.length===a.features.length&&$.ajax({method:"POST",url:app.config.apiBase+"/geoprocessing/routeparts",data:JSON.stringify(jsonToObject(routesJSON.routes)),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){for(var e=0;e<t.data.features.length;e++)r(t.data.features[e])},error:function(t){alert(t)}})}routesJSON.routes.length>0?console.log("ROUTING CACHED"):$.ajax({dataType:"json",url:app.config.apiBase+"/route/"+e+"/"+s,success:o,error:function(t){alert(t)}})}this.svglayer=e.append("g").attr("id","routesfromvalledupar"),this.setActive(!0),t.svglayer.selectAll("g").data(a.features).enter().append("g").attr("class","smallmultiple sm_vis").attr("data-id",function(t){return t.properties.osm_id}).each(function(t){var e=t.geometry.coordinates[1]+","+t.geometry.coordinates[0];s(app.config.coordHomeBase,e,t.properties.osm_id)})},this.update=function(t){this.calc(),this.render(t)},this.calc=function(){if("smallmultiples"===app.view){var e=0,a=0,s=0,i=0;this.svglayer.selectAll(".smallmultiple").each(function(){var t=d3.select(this).node().getBBox();t.height>i&&(i=t.height),t.width>s&&(s=t.width)});var r=(app.layout.heightperelement-20)/i,o=app.layout.widthperelement/s;t.scaleFactor=r,o<t.scaleFactor&&(t.scaleFactor=o),this.svglayer.selectAll(".smallmultiple").each(function(s){var i=d3.select(this),r=s.geometry.coordinates,o=app.layout.offsetLeft+e*(app.layout.gapX+app.layout.widthperelement),l=app.layout.offsetTop+a*(app.layout.gapY+app.layout.heightperelement);e++,e===app.layout.cols&&(e=0),a++,a===app.layout.rows&&(a=0),i.attr("data-transformX",o).attr("data-transformY",l),smpos[i.attr("data-id")]={},smpos[i.attr("data-id")].x=o,smpos[i.attr("data-id")].y=l,console.log(smpos[i.attr("data-id")]);var n=i.node().getBBox(),p=-n.x*t.scaleFactor,c=(-n.y-n.height+(app.layout.heightperelement-20)/t.scaleFactor)*t.scaleFactor;i.attr("data-transformX",p).attr("data-transformY",c);var u=parseFloat(project(r).x*t.scaleFactor)+p+o,d=parseFloat(project(r).y*t.scaleFactor)+c+l;t.active&&(app.villagePositions[i.attr("data-id")]={},app.villagePositions[i.attr("data-id")].x=u,app.villagePositions[i.attr("data-id")].y=d)})}else t.active&&(app.villagePositions=app.villagePositionsMap.slice())},this.render=function(e){"smallmultiples"===app.view?this.svglayer.selectAll(".smallmultiple").each(function(){var a=d3.select(this),s=a.attr("data-id");app.config.layoutdebug===!0&&a.selectAll(".layoutdebug").attr("width",app.layout.widthperelement).attr("height",app.layout.heightperelement),a.transition().duration(e).attr("transform",function(){return"translate("+smpos[s].x+","+smpos[s].y+") scale("+t.scaleFactor+")"})}):this.svglayer.selectAll(".smallmultiple").each(function(){var a=d3.select(this);t.lastView===app.view&&""!==t.lastView||a.transition().duration(e).attr("transform",""),a.selectAll("path").each(function(){var e=d3.select(this);e.attr("d",lineFunction(t.routes_geo[e.attr("data-id")]))})}),t.lastView=app.view}}
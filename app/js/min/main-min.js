function addLayer(e,t,a){config.layers[e]={},config.layers[e].active=t,config.layers[e].layer=new a}function init(){$.getScript("js/routesLayer.js",function(e,t,a){addLayer("routesfromvalledupar",!1,routesLayer),$.getScript("js/missingInfrastructureLayer.js",function(e,t,a){addLayer("missinginfrastructure",!1,missingInfrastructureLayer),$.getScript("js/isolinesLayer.js",function(e,t,a){addLayer("isolines",!1,isolinesLayer),d3.json("../../data/places_aoi.json",function(e,t){places_aoi=t,d3.json("../../data/street_points_aoi.json",function(e,a){street_points_aoi=a,$.get("data/routes_cached.json").done(function(){d3.json("data/routes_cached.json",function(e,a){for(var o=0;o<routesJSON.routes.length;o++);mapDraw(t)})}).fail(function(){mapDraw(t)})})})})})})}function mapDraw(e){function t(){$("#loader").removeClass("show"),setTimeout(function(){$("#loader").removeClass("displayed")},1e3)}function a(e){"DIGENTI"===e?map.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"DIGENTI-Light"===e?map.setStyle("mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi"):"DIGENTI-Dark"===e?map.setStyle("mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t"):"fos-outdoor"===e?map.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):map.setStyle("mapbox://styles/mapbox/"+e)}mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A";var o="dark"==theme?"mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t":"mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi";console.log(o),map=new mapboxgl.Map({container:"map",style:o,zoom:11,center:[-73.12,10.41]}),map.addControl(new mapboxgl.Navigation),map.on("viewreset",update),map.on("moveend",update),map.on("move",update),map.on("load",t),svg=d3.select(map.getCanvasContainer()).append("svg").attr("class","map-features"),lineFunction=d3.svg.line().x(function(e){return project(e).x}).y(function(e){return project(e).y}).interpolate("linear"),settlementPointLayer=svg.append("g").attr("id","settlementPointLayer"),settlementPointLayer.selectAll("circle").data(places_aoi.features).enter().append("circle").attr("class","village").attr("r",config.circleRadius).attr("data-id",function(e){return e.properties.osm_id}),config.layers.routesfromvalledupar.layer.init(svg,e),config.layers.missinginfrastructure.layer.init(svg,e),config.layers.isolines.layer.init(svg,e),$("#basemap_select").change(function(){a($(this).val())})}function update(e){isNaN(e)&&(e=0),config.layout=calculateLayoutVars(),config.layers.routesfromvalledupar.layer.update(e),config.layers.missinginfrastructure.layer.update(e),config.layers.isolines.layer.update(e)}function reorderSmallMultiples(e){config.orderby=e,d3.selectAll(".orderby").classed("active",!1),d3.selectAll("."+config.orderby).classed("active",!0),update(500)}function setMode(e){config.mode=e,console.log("Set Mode: "+config.mode);var t=0;"smallmultiples"===config.view&&(t=500),config.layers[e].active=!config.layers[e].active,d3.selectAll(".mode."+e).classed("active",config.layers[e].active),"smallmultiples"===config.view&&updateSettlementPointLayer(),setTimeout(function(){config.layers[e].layer.setActive(config.layers[e].active),update(500)},t)}function toggleViews(){"smallmultiples"==config.view?triggerMapView():triggerSmallMultiplesView()}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),showMap(),enableMapInteraction(),config.view="",update(500)}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!1),hideMap(),disableMapInteraction(),config.view="smallmultiples",update(500)}function enableMapInteraction(){map.scrollZoom.enable(),map.dragPan.enable(),d3.select("#map").classed("disabled",!1)}function disableMapInteraction(){map.scrollZoom.disable(),map.dragPan.disable(),d3.select("#map").classed("disabled",!0)}function showMap(){d3.selectAll(".mapboxgl-canvas").classed("hidden",!1),d3.selectAll(".mapboxgl-canvas").classed("hidden",!1)}function hideMap(){d3.selectAll(".mapboxgl-canvas").classed("hidden",!0),d3.selectAll(".mapboxgl-canvas").classed("hidden",!0)}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}function updateSettlementPointLayer(){console.log("updateSettlementsPointLayer"),"isolines"===config.mode?test123(config.layers.isolines.layer.bcr):"routesfromvalledupar"===config.mode?test123(config.layers.routesfromvalledupar.layer.bcr):"missinginfrastructure"===config.mode&&test123(config.layers.missinginfrastructure.layer.bcr)}function test123(e){console.log("test123, mode: "+config.mode),isDefined(e)&&settlementPointLayer.selectAll("circle").each(function(){var t=d3.select(this),a=t.attr("data-id");isDefined(e[a])&&t.attr("opacity","1").transition().each("end",function(){t.transition().duration(500).attr("opacity","0")}).duration(500).attr("cx",e[a].left+config.circleRadius).attr("cy",e[a].top+config.circleRadius)})}function selectSettlement(e){console.log(e),$("p.objectID").html(e)}function calculateLayoutVars(){var e={};return e.w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e.h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),e.rows=7,e.cols=6,e.navWidth=Math.round($("#nav").width()),e.offsetRight=Math.round(.01*e.w),e.offsetLeft=e.navWidth+50,e.offsetTop=Math.round(e.offsetRight),e.offsetBottom=Math.round(e.offsetRight),e.gapX=Math.round(.008*e.w),e.gapY=Math.round(e.gapX),e.widthperelement=Math.round((e.w-e.offsetLeft-e.offsetRight-(e.cols-1)*e.gapX)/e.cols),e.heightperelement=Math.round((e.h-e.offsetTop-e.offsetBottom-(e.rows-1)*e.gapY)/e.rows),e}function project(e){return map.project(new mapboxgl.LngLat(+e[0],+e[1]))}function projectPoint(e,t){var a=map.project(new mapboxgl.LngLat(e,t));this.stream.point(a.x,a.y)}function isDefined(e){return"undefined"!=typeof e&&null!==e}var $body,coord_valledupar="10.471667,-73.25",layoutdebug=!1,theme="light",map,svg,settlementPointLayer,lineFunction,places_aoi,street_points_aoi,routesArray=[],routesJSON={};routesJSON.routes=[];var config={};config.view="",config.mode="",config.orderby="size",config.layout={},config.circleRadius=5,config.layers=[],$(document).ready(function(){$body=$("body"),theme=$body.hasClass("dark")?"dark":"light",console.log("theme: "+theme),init()});
function routesLayer(t){var e=this;this.svglayer="",this.routes_geo=[],this.bcr=[],this.active=!0,this.setActive=function(t){null==t?this.active=!this.active:this.active=t,this.svglayer.classed("disabled",!this.active)},this.init=function(t,i){function a(t,a,l){function r(t){console.log(t)}function o(t){e.svglayer.selectAll("g[data-id='"+t.id+"']").selectAll("g").append("path").attr("data-id",t.id).attr("data-traveltime",t.travelTime).attr("class","route").attr("d",t.path),e.routes_geo[t.id]=t.geometry.coordinates}function s(t){var e={init:function(){return this.id=l,this.geometry=t.geometry,this.travelTime=t.properties.travelTime,this.path=lineFunction(this.geometry.coordinates),this}}.init(),a={};a.id=l,a.route=e,routesJSON.routes.push(a),routesJSON.routes.length===i.features.length,o(e)}routesJSON.routes.length>0?(console.log("ROUTING CACHED"),o(routesArray[l])):(console.log("ROUTING VIA API"),$.ajax({dataType:"json",url:"http://localhost:61002/api/route/"+t+"/"+a,success:s,error:function(t){alert(t)}}))}this.svglayer=t.append("g").attr("id","routesfromvalledupar"),this.setActive(!1),e.svglayer.selectAll("g").data(i.features).enter().append("g").attr("class","smallmultiple").attr("data-id",function(t){return t.properties.osm_id}).each(function(t){var e=d3.select(this);e.append("text").text(function(t){return t.properties.name}).attr("class","title").attr("y","30"),1==layoutdebug&&e.append("rect").attr("class","layoutdebug")}).append("g").attr("class","sm_vis").append("circle").attr("data-id",function(t){return t.properties.osm_id}).attr({r:config.circleRadius}).attr("class","village").each(function(t){var e=d3.select(this),i=t.geometry.coordinates[1]+","+t.geometry.coordinates[0];a(coord_valledupar,i,t.properties.osm_id)})},this.update=function(t){if("smallmultiples"===config.view){var i=0,a=0,l=0,r=0;this.svglayer.selectAll(".smallmultiple").selectAll("g").each(function(){var t=d3.select(this).node().getBBox();t.height>r&&(r=t.height),t.width>l&&(l=t.width)});var o=(config.layout.heightperelement-20)/r,s=config.layout.widthperelement/l,n=o;n>s&&(n=s),this.svglayer.selectAll(".smallmultiple").each(function(){var l=d3.select(this);l.transition().duration(t).style("opacity",1).attr("transform",function(){var t=config.layout.offsetLeft+(i-1)*config.layout.gapX+i*config.layout.widthperelement,e=config.layout.offsetTop+(a-1)*config.layout.gapY+a*config.layout.heightperelement;return i++,i===config.layout.cols&&(i=0),a++,a===config.layout.rows&&(a=0),"translate("+t+","+e+")"}),layoutdebug===!0&&l.selectAll(".layoutdebug").attr("width",config.layout.widthperelement).attr("height",config.layout.heightperelement),l.selectAll("text").attr("x",0).attr("y",config.layout.heightperelement).transition().duration(t).style("opacity",1),l.selectAll("g").transition().duration(t).style("opacity",1).attr("transform",function(){var t=d3.select(this).node().getBBox(),e=-t.x,i=-t.y-t.height+(config.layout.heightperelement-20)/n;return"scale("+n+") translate("+e+","+i+")"}),l.selectAll("g").selectAll("path").transition().duration(t).style("stroke-width",function(){return 2/n}),l.selectAll("g").selectAll("circle").attr({r:config.circleRadius/n}),l.selectAll("g").selectAll("circle").each(function(){e.bcr[d3.select(this).attr("data-id")]=d3.select(this).node().getBoundingClientRect()})})}else this.svglayer.selectAll(".smallmultiple").each(function(){var i=d3.select(this);i.transition().duration(t).style("opacity",1).attr("transform",""),i.selectAll("text").transition().duration(t).style("opacity",0),i.selectAll("g").transition().duration(t).attr("transform",""),i.selectAll("g").selectAll("path").each(function(){var t=d3.select(this);t.attr("d",lineFunction(e.routes_geo[t.attr("data-id")]))}).transition().duration(t).attr("style",""),i.selectAll("g").selectAll("circle").attr({cx:function(t){return project(t.geometry.coordinates).x},cy:function(t){return project(t.geometry.coordinates).y}}).transition().duration(t).attr({r:config.circleRadius})})}}
function routesLayer(t){var e=this;this.svglayer="",this.routes_geo=[],this.bcr=[],this.setActive=function(t){this.active=t,this.svglayer.transition().duration(500).style("opacity",function(){return t?1:0})},this.init=function(t,a){function i(t,a,i){function o(t){console.log(t)}function r(t){e.svglayer.selectAll("g[data-id='"+t.id+"']").selectAll("g").append("path").attr("data-id",t.id).attr("data-traveltime",t.travelTime).attr("class","route").attr("stroke-width",3).attr("d",t.path),e.routes_geo[t.id]=t.geometry.coordinates}function l(t){var e={init:function(){return this.id=i,this.geometry=t.geometry,this.travelTime=t.properties.travelTime,this.path=lineFunction(this.geometry.coordinates),this}}.init(),a={};a.id=i,a.route=e,routesJSON.routes.push(a),r(e)}routesJSON.routes.length>0?(console.log("ROUTING CACHED"),r(routesArray[i])):(console.log("ROUTING VIA API"),$.ajax({dataType:"json",url:"http://localhost:61002/api/route/"+t+"/"+a,success:l,error:function(t){alert(t)}}))}this.svglayer=t.append("g").attr("class","routesfromvalledupar"),this.setActive(!1),e.svglayer.selectAll("g").data(a.features).enter().append("g").attr("class","smallmultiple").attr("data-id",function(t){return t.properties.osm_id}).each(function(t){var e=d3.select(this);e.append("text").text(function(t){return t.properties.name}).attr("class","title").attr("y","30"),e.append("rect").attr("class","layoutdebug")}).append("g").attr("class","sm_vis").append("circle").attr("data-id",function(t){return t.properties.osm_id}).attr({r:config.circleRadius}).attr("class","village").each(function(t){var e=d3.select(this),a=t.geometry.coordinates[1]+","+t.geometry.coordinates[0];i(coord_valledupar,a,t.properties.osm_id)})},this.update=function(t){if("smallmultiples"===config.view){var a=0,i=0,o=0,r=0;this.svglayer.selectAll(".smallmultiple").selectAll("g").each(function(){var t=d3.select(this).node().getBBox();t.height>r&&(r=t.height),t.width>o&&(o=t.width)});var l=(config.layout.w-config.layout.offsetLeft-config.layout.offsetRight-(config.layout.cols-1)*config.layout.gapX)/config.layout.cols,s=(config.layout.h-config.layout.offsetTop-config.layout.offsetBottom-(config.layout.rows-1)*config.layout.gapY)/config.layout.rows,n=(s-20)/r,c=l/o,u=n;u>c&&(u=c),this.svglayer.selectAll(".smallmultiple").each(function(){var o=d3.select(this);o.transition().duration(t).style("opacity",1).attr("transform",function(){var t=config.layout.offsetLeft+(a-1)*config.layout.gapX+a*l,e=config.layout.offsetTop+(i-1)*config.layout.gapY+i*s;return a++,a===config.layout.cols&&(a=0),i++,i===config.layout.rows&&(i=0),"translate("+t+","+e+")"}),layoutdebug===!0?o.selectAll(".layoutdebug").attr("fill","rgba(255, 0, 255, 0.3)").attr("width",l).attr("height",s):o.selectAll(".layoutdebug").attr("fill","none").attr("width",l).attr("height",s),o.selectAll("text").attr("x",0).attr("y",s).transition().duration(t).style("opacity",1),o.selectAll("g").transition().duration(t).style("opacity",1).attr("transform",function(){var t=d3.select(this).node().getBBox(),e=-t.x,a=-t.y-t.height+(s-20)/u;return"scale("+u+") translate("+e+","+a+")"}),o.selectAll("g").selectAll("path").transition().duration(t).attr("stroke-width",function(){return 2/u}),o.selectAll("g").selectAll("circle").attr({r:config.circleRadius/u}),o.selectAll("g").selectAll("circle").each(function(){e.bcr[d3.select(this).attr("data-id")]=d3.select(this).node().getBoundingClientRect()})}),setMapOpacity(.08),disableMapInteraction()}else setMapOpacity(1),enableMapInteraction(),this.svglayer.selectAll(".smallmultiple").each(function(){var a=d3.select(this);a.transition().duration(t).style("opacity",1).attr("stroke-width",2).attr("transform",""),a.selectAll("text").transition().duration(t).style("opacity",0),a.selectAll("g").transition().duration(t).attr("transform",""),a.selectAll("g").selectAll("path").each(function(){var t=d3.select(this);t.attr("d",lineFunction(e.routes_geo[t.attr("data-id")]))}).transition().duration(t).attr("stroke-width",function(){return 2}),a.selectAll("g").selectAll("circle").attr({cx:function(t){return project(t.geometry.coordinates).x},cy:function(t){return project(t.geometry.coordinates).y}}).transition().duration(t).attr({r:config.circleRadius})})}}
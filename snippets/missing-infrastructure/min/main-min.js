function mapDraw(t){mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A",map=new mapboxgl.Map({container:"map",style:"mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi",zoom:11,center:[-73.05,10.41]}),map.addControl(new mapboxgl.Navigation),map.on("style.load",function(){});var e=map.getCanvasContainer();svg=d3.select(e).append("svg").attr("class","map-features"),featureElement=svg.append("g").attr("class","villages").selectAll("g").data(t.features).enter().append("g").attr("class","village-group").append("circle").attr({r:8}).attr("class","village").attr("data-id",function(){return generateUniqueID()}).on("click",function(){d3.select(this).classed("selected",!0);var t=d3.select(this).attr("data-id")}),map.on("viewreset",update),map.on("movestart",function(){}),map.on("moveend",function(){update(0)}),update(0),distanceAll(),triggerMapDistancesView()}function update(t){if(t=void 0===typeof t?0:t,w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),"smallmultiples"===view){console.log("small multiples - orderby: "+orderby);var e=0,a=0,s=7,n=6,r=.8*w/(n+1),o=h/(s+1);console.log("gap hor: "+r);for(var i=[],c=[],l=0;l<places_aoi_street_distance.features.length;l++)i.push(places_aoi_street_distance.features[l].properties.connections.distance_to_street);var p=Math.max.apply(null,i),d=.8*r/(2*p);svg.selectAll(".village-group").each(function(i){var c=d3.select(this);c.transition().duration(t).style("opacity",1).attr("transform",function(){if("distance"==orderby){var t=i.properties.connections.distance_order;a=Math.floor(t/n),e=Math.round(n*(t/n-a))}var s=.2*w+e*r+r/2,c=a*o+o;return"translate("+s+","+c+")"}),c.select(".village").transition().duration(t).attr("cx",function(){var t=8;return i.properties.connections.distance_to_street>0&&(t=2*d*i.properties.connections.distance_to_street),t}),c.select(".nearest-road").transition().duration(t).style("opacity",1).attr("cy",0).attr("cx",function(){var t=8;return i.properties.connections.distance_to_street>0&&(t=0),t}),c.select("line").transition().duration(t).attr("x1",0).attr("y1",0).attr("x2",2*d*i.properties.connections.distance_to_street).attr("y2",0),c.selectAll("text").attr("x",0).transition().duration(500).style("opacity",1),setMapOpacity(.08),"size"==orderby&&(e++,e===n&&(e=0),a++,a===s&&(a=0))})}else"map-distances"===view?svg.selectAll(".village-group").each(function(e){var a=d3.select(this),s=project(e.geometry.coordinates).x,n=project(e.geometry.coordinates).y,r=project(e.properties.connections.nearest_point).x-s,o=project(e.properties.connections.nearest_point).y-n;a.transition().duration(t).style("opacity",.4).attr("transform",function(){return"translate("+s+","+n+")"}),a.select(".village").transition().duration(t).attr("cx",function(){return 0}),a.select(".nearest-road").transition().duration(t).style("opacity",1).attr("cx",r).attr("cy",o),a.select("line").transition().duration(t).attr("x1",0).attr("y1",0).attr("x2",r).attr("y2",o),a.selectAll("text").transition().duration(t).style("opacity",0),setMapOpacity(1)}):svg.selectAll(".village-group").each(function(e){var a=d3.select(this),s=project(e.geometry.coordinates).x,n=project(e.geometry.coordinates).y;a.transition().duration(t).style("opacity",.4).attr("transform",function(){return"translate("+s+","+n+")"}),a.select(".village").transition().duration(t).attr("cx",function(){return 0}),a.select(".nearest-road").transition().duration(t).style("opacity",0),a.select("line").transition().duration(t).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0),a.selectAll("text").transition().duration(t).style("opacity",0),setMapOpacity(1)});console.log("UPDATE")}function project(t){return map.project(new mapboxgl.LngLat(+t[0],+t[1]))}function distanceAll(){for(var t=0;t<places_aoi.features.length;t++){var e=places_aoi.features[t];calculateDistance(e.geometry.coordinates,e.properties.osm_id,e)}var a=places_aoi_street_distance.features,s=a.map(function(t,e){return{index:e,value:t}});s.sort(function(t,e){return e.value.properties.connections.distance_to_street-t.value.properties.connections.distance_to_street});for(var t=0;t<s.length;t++)places_aoi_street_distance.features[s[t].index].properties.connections.distance_order=t}function calculateDistance(t,e,a){var s,n={type:"Feature",properties:{"marker-color":"#f00"},geometry:{type:"Point",coordinates:t}},r=turf.nearest(n,street_points_aoi),o=turf.distance(n,r,"kilometers");s=.2>o?{touches_street:!0,distance_to_street:1e3*o,nearest_point:r.geometry.coordinates}:{touches_street:!1,distance_to_street:1e3*o,nearest_point:r.geometry.coordinates},a.properties.connections=s,places_aoi_street_distance.features.push(a),places_aoi_street_distance.features.length===places_aoi.features.length&&(activateButtons(),places_aoi_street_distance.features.sort(function(t,e){return d3.ascending(t.properties.name,e.properties.name)}),svg.selectAll(".village").data(places_aoi_street_distance.features).attr("data-distance",function(t){return t.properties.connections.distance_to_street}).attr("data-touches",function(t){return t.properties.connections.touches_street}).enter(),svg.selectAll(".village-group").each(function(t){var e=d3.select(this);e.append("line").attr("class","missing"),e.append("circle").attr({r:4}).attr("class","nearest-road"),e.append("text").text(t.properties.name).attr("class","title").attr("y","30"),e.append("text").attr("class","text").text(Math.round(t.properties.connections.distance_to_street)+" m to street").attr("y","45")}),update(0))}function switchLayer(t){"DIGENTI"==t?map.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"DIGENTI-Light"==t?map.setStyle("mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi"):"DIGENTI-Dark"==t?map.setStyle("mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t"):"fos-outdoor"==t?map.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):map.setStyle("mapbox://styles/mapbox/"+t)}function reorderSmallMultiples(t){orderby=t,d3.selectAll(".orderby").classed("active",!1),d3.selectAll("."+orderby).classed("active",!0),update(500)}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),view="",update(500)}function triggerMapDistancesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapdistancesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),view="map-distances",update(500)}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!1),view="smallmultiples",update(500)}function setMapOpacity(t){d3.selectAll(".mapboxgl-canvas").transition().duration(500).style("opacity",t),d3.selectAll(".mapboxgl-control-container").transition().duration(500).style("opacity",t)}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}function sortByDistanceDesc(t,e){return e.properties.connections.distance_to_street-t.properties.connections.distance_to_street}var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),map,featureElement,svg,view="",orderby="size",places_aoi,street_points_aoi,places_aoi_street_distance={type:"FeatureCollection",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[]};d3.json("../../data/places_aoi.json",function(t,e){places_aoi=e,d3.json("../../data/street_points_aoi.json",function(t,e){street_points_aoi=e,mapDraw(places_aoi)})});var basemap_select=document.getElementById("basemap_select"),basemap_select_options=basemap_select.options;basemap_select.onchange=function(){var t=basemap_select_options[basemap_select.selectedIndex].value;switchLayer(t)};
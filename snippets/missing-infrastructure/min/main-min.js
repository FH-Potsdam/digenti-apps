function mapDraw(e){mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A",map=new mapboxgl.Map({container:"map",style:"mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi",zoom:11,center:[-73.05,10.41]}),map.addControl(new mapboxgl.Navigation),map.on("style.load",function(){});var t=map.getCanvasContainer();svg=d3.select(t).append("svg").attr("class","map-features"),featureElement=svg.append("g").attr("class","villages").selectAll("g").data(e.features).enter().append("g").attr("class","village-group").append("circle").attr({r:8}).attr("class","village").attr("data-id",function(){return generateUniqueID()}).on("click",function(){d3.select(this).classed("selected",!0);var e=d3.select(this).attr("data-id")}),map.on("viewreset",update),map.on("movestart",function(){svg.classed("hidden",!0)}),map.on("moveend",function(){update(0),svg.classed("hidden",!1)}),update(0),distanceAll(),triggerMapDistancesView()}function update(e){if(e="undefined"!=typeof e?e:0,w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),"smallmultiples"===view){console.log("small multiples - orderby: "+orderby);var t=0,a=0,s=7,n=6,r=.8*w/(n+1),i=h/(s+1);console.log("gap hor: "+r);for(var o=[],c=[],l=0;l<places_aoi_street_distance.features.length;l++)o.push(places_aoi_street_distance.features[l].properties.connections.distance_to_street);var d=Math.max.apply(null,o),p=.8*r/(2*d);svg.selectAll(".village-group").each(function(o){var c=d3.select(this);c.transition().duration(e).style("opacity",1).attr("transform",function(){if("distance"==orderby){var e=o.properties.connections.distance_order;a=Math.floor(e/n),t=Math.round(n*(e/n-a))}var s=.2*w+t*r+r/2,c=a*i+i;return"translate("+s+","+c+")"}),c.select(".village").transition().duration(e).attr("cx",function(){var e=8;return o.properties.connections.distance_to_street>0&&(e=2*p*o.properties.connections.distance_to_street),e}),c.select(".nearest-road").transition().duration(e).style("opacity",1).attr("cy",0).attr("cx",function(){var e=8;return o.properties.connections.distance_to_street>0&&(e=0),e}),c.select("line").transition().duration(e).attr("x1",0).attr("y1",0).attr("x2",2*p*o.properties.connections.distance_to_street).attr("y2",0),c.selectAll("text").attr("x",0).transition().duration(500).style("opacity",1),setMapOpacity(.08),"size"==orderby&&(t++,t===n&&(t=0),a++,a===s&&(a=0))})}else"map-distances"===view?svg.selectAll(".village-group").each(function(t){var a=d3.select(this),s=project(t.geometry.coordinates).x,n=project(t.geometry.coordinates).y,r=project(t.properties.connections.nearest_point).x-s,i=project(t.properties.connections.nearest_point).y-n;a.transition().duration(e).style("opacity",.4).attr("transform",function(){return"translate("+s+","+n+")"}),a.select(".village").transition().duration(e).attr("cx",function(){return 0}),a.select(".nearest-road").transition().duration(e).style("opacity",1).attr("cx",r).attr("cy",i),a.select("line").transition().duration(e).attr("x1",0).attr("y1",0).attr("x2",r).attr("y2",i),a.selectAll("text").transition().duration(e).style("opacity",0),setMapOpacity(1)}):svg.selectAll(".village-group").each(function(t){var a=d3.select(this),s=project(t.geometry.coordinates).x,n=project(t.geometry.coordinates).y;a.transition().duration(e).style("opacity",.4).attr("transform",function(){return"translate("+s+","+n+")"}),a.select(".village").transition().duration(e).attr("cx",function(){return 0}),a.select(".nearest-road").transition().duration(e).style("opacity",0),a.select("line").transition().duration(e).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0),a.selectAll("text").transition().duration(e).style("opacity",0),setMapOpacity(1)});console.log("UPDATE")}function project(e){return map.project(new mapboxgl.LngLat(+e[0],+e[1]))}function distanceAll(){for(var e=0;e<places_aoi.features.length;e++){var t=places_aoi.features[e];calculateDistance(t.geometry.coordinates,t.properties.osm_id,t)}var a=places_aoi_street_distance.features,s=a.map(function(e,t){return{index:t,value:e}});s.sort(function(e,t){return t.value.properties.connections.distance_to_street-e.value.properties.connections.distance_to_street});for(var e=0;e<s.length;e++)places_aoi_street_distance.features[s[e].index].properties.connections.distance_order=e}function calculateDistance(e,t,a){var s,n={type:"Feature",properties:{"marker-color":"#f00"},geometry:{type:"Point",coordinates:e}},r=turf.nearest(n,street_points_aoi),i=turf.distance(n,r,"kilometers");s=.2>i?{touches_street:!0,distance_to_street:1e3*i,nearest_point:r.geometry.coordinates}:{touches_street:!1,distance_to_street:1e3*i,nearest_point:r.geometry.coordinates},a.properties.connections=s,places_aoi_street_distance.features.push(a),places_aoi_street_distance.features.length===places_aoi.features.length&&(activateButtons(),places_aoi_street_distance.features.sort(function(e,t){return d3.ascending(e.properties.name,t.properties.name)}),svg.selectAll(".village").data(places_aoi_street_distance.features).attr("data-distance",function(e){return e.properties.connections.distance_to_street}).attr("data-touches",function(e){return e.properties.connections.touches_street}).enter(),svg.selectAll(".village-group").each(function(e){var t=d3.select(this);t.append("line").attr("class","missing"),t.append("circle").attr({r:4}).attr("class","nearest-road"),t.append("text").text(e.properties.name).attr("class","title").attr("y","30"),t.append("text").attr("class","text").text(Math.round(e.properties.connections.distance_to_street)+" m to street").attr("y","45")}),update(0))}function enableMapInteraction(){map.scrollZoom.enable(),map.dragPan.enable(),d3.select("#map").classed("disabled",!1)}function disableMapInteraction(){map.scrollZoom.disable(),map.dragPan.disable(),d3.select("#map").classed("disabled",!0)}function switchLayer(e){"DIGENTI"==e?map.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"DIGENTI-Light"==e?map.setStyle("mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi"):"DIGENTI-Dark"==e?map.setStyle("mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t"):"fos-outdoor"==e?map.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):map.setStyle("mapbox://styles/mapbox/"+e)}function reorderSmallMultiples(e){orderby=e,d3.selectAll(".orderby").classed("active",!1),d3.selectAll("."+orderby).classed("active",!0),update(500)}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),enableMapInteraction(),view="",update(500)}function triggerMapDistancesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapdistancesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),enableMapInteraction(),view="map-distances",update(500)}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!1),disableMapInteraction(),view="smallmultiples",update(500)}function setMapOpacity(e){d3.selectAll(".mapboxgl-canvas").transition().duration(500).style("opacity",e),d3.selectAll(".mapboxgl-control-container").transition().duration(500).style("opacity",e)}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}function sortByDistanceDesc(e,t){return t.properties.connections.distance_to_street-e.properties.connections.distance_to_street}var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),map,featureElement,svg,view="",orderby="size",places_aoi,street_points_aoi,places_aoi_street_distance={type:"FeatureCollection",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[]};d3.json("../../data/places_aoi.json",function(e,t){places_aoi=t,d3.json("../../data/street_points_aoi.json",function(e,t){street_points_aoi=t,mapDraw(places_aoi)})});var basemap_select=document.getElementById("basemap_select"),basemap_select_options=basemap_select.options;basemap_select.onchange=function(){var e=basemap_select_options[basemap_select.selectedIndex].value;switchLayer(e)};
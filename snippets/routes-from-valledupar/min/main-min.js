function initGSM(t,e){function a(t,e,a){function n(t){console.log(t)}function r(t){gSM.selectAll("g[data-id='"+t.id+"']").selectAll("g").append("path").attr("data-id",t.id).attr("data-traveltime",t.travelTime).attr("class","route").attr("d",t.path).attr("stroke-width",2),routes_geo[t.id]=t.geometry,update(500)}function o(t){var e={init:function(){return this.id=a,this.geometry=transformHEREgeometry(t.response.route[0].shape),this.travelTime=t.response.route[0].summary.travelTime,this.path=lineFunction(this.geometry),this}}.init(),n={};n.id=a,n.route=e,routesJSON.routes.push(n),r(e)}var i={mode:"fastest;car",representation:"display",routeattributes:"waypoints,summary,shape,legs",maneuverattributes:"direction,action",waypoint0:t,waypoint1:e,returnelevation:"true"};routesJSON.routes.length>0?(console.log("ROUTING CACHED"),r(routesArray[a])):(console.log("ROUTING VIA API"),router.calculateRoute(i,o,n))}gSM=t.append("g").attr("class","smallmultiples"),gSM.selectAll("g").data(e.features).enter().append("g").attr("class","smallmultiple").attr("data-id",function(t){return t.properties.osm_id}).each(function(t){var e=d3.select(this);e.append("text").text(function(t){return t.properties.name}).attr("text-anchor","middle").attr("class","title").attr("y","30")}).append("g").attr("class","sm_vis").append("circle").attr({r:8}).attr("class","village").each(function(t){var e=d3.select(this),n="10.471667,-73.25",r=t.geometry.coordinates[1]+","+t.geometry.coordinates[0];a(n,r,t.properties.osm_id)})}function mapDraw(t){function e(t){"DIGENTI"===t?map.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"DIGENTI-Light"===t?map.setStyle("mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi"):"DIGENTI-Dark"===t?map.setStyle("mapbox://styles/jorditost/cir1xojwe0020chknbi0y2d5t"):"fos-outdoor"===t?map.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):map.setStyle("mapbox://styles/mapbox/"+t)}mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A",map=new mapboxgl.Map({container:"map",style:"mapbox://styles/jorditost/ciqc61l3p0023dunqn9e5t4zi",zoom:11,center:[-73.02,10.41]}),map.addControl(new mapboxgl.Navigation),map.on("viewreset",update),map.on("moveend",update),map.on("move",update);var a=d3.select(map.getCanvasContainer()).append("svg").attr("class","map-features");lineFunction=d3.svg.line().x(function(t){return project(t).x}).y(function(t){return project(t).y}).interpolate("linear"),gRouteParts=a.append("g").attr("class","routeparts"),initGSM(a,t),triggerMapView(),update(500);var n=document.getElementById("basemap_select"),r=n.options;n.onchange=function(){var t=r[n.selectedIndex].value;e(t)}}function update(t){if("smallmultiples"===config.view){console.log("triggerSmallMultiplesView");var e=0,a=0,n=7,r=6,o=20,i=0,l=0;gSM.selectAll(".smallmultiple").selectAll("g").each(function(){var t=d3.select(this).node().getBBox(),e=t.width,a=t.height;a>l&&(l=a),e>i&&(i=e)});var s=.8*w/r,c=h/n-o,u=.2*w,d=c/l,p=s/i,m=d;m>p&&(m=p),gSM.selectAll(".smallmultiple").each(function(){var i=d3.select(this);i.transition().duration(t).style("opacity",1).attr("transform",function(){var t=u+e*s,i=a*(c+o);return e++,e===r&&(e=0),a++,a===n&&(a=0),"translate("+t+","+i+")"}),i.append("rect").attr("fill","none").attr("width",s).attr("height",c),i.selectAll("text").attr("x",s/2).attr("y",c).transition().duration(t).style("opacity",1),i.selectAll("g").transition().duration(t).style("opacity",1).attr("transform",function(){var t=d3.select(this).node().getBBox(),e=(s/m-(t.width+t.x))/2,a=(c/m-(t.width+t.y))/2;return"scale("+m+") translate("+e+","+a+")"}),i.selectAll("g").selectAll("path").transition().duration(t).attr("stroke-width",function(){return 2/m}),i.selectAll("g").selectAll("circle").transition().duration(t).attr({r:4/m})}),setMapOpacity(.08),disableMapInteraction()}else setMapOpacity(1),enableMapInteraction(),gSM.selectAll(".smallmultiple").each(function(){var e=d3.select(this);e.transition().duration(t).style("opacity",1).attr("stroke-width",2).attr("transform",function(){return""}),e.selectAll("text").transition().duration(t).style("opacity",0),e.selectAll("g").transition().duration(t).attr("transform",function(){return""}),e.selectAll("g").selectAll("path").each(function(){var t=d3.select(this);t.attr("d",lineFunction(routes_geo[t.attr("data-id")]))}).transition().duration(t).attr("stroke-width",function(){return 2}),e.selectAll("g").selectAll("circle").attr({cx:function(t){return project(t.geometry.coordinates).x},cy:function(t){return project(t.geometry.coordinates).y}}).transition().duration(t).attr({r:8})})}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!0),config.view="",update(500)}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),d3.selectAll("#orderby").classed("disabled",!1),config.view="smallmultiples",update(500)}function setMapOpacity(t){d3.selectAll(".mapboxgl-canvas").transition().duration(500).style("opacity",t),d3.selectAll(".mapboxgl-control-container").transition().duration(500).style("opacity",t)}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}function enableMapInteraction(){map.scrollZoom.enable(),map.dragPan.enable(),d3.select("#map").classed("disabled",!1)}function disableMapInteraction(){map.scrollZoom.disable(),map.dragPan.disable(),d3.select("#map").classed("disabled",!0)}function project(t){return map.project(new mapboxgl.LngLat(+t[0],+t[1]))}var platform=new H.service.Platform({app_id:"EOg7UyuSFbPF0IG5ANjz",app_code:"iRnqNl0dyzX_8FOlchD0ZQ"}),router=platform.getRoutingService(),w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),routing_history=[],routes_collection=[],knotpoints=[],overlapping_routes=[],lineFunction,gRouteParts,gSM,currentMode,map,routes_geo=[],routesArray=[],routesJSON={};routesJSON.routes=[];var resultingGEOJSON={};resultingGEOJSON.type="FeatureCollection",resultingGEOJSON.features=[];var config={};config.view="",d3.json("../../data/places_aoi.json",function(t,e){$.get("data/routes_cached.json").done(function(){d3.json("data/routes_cached.json",function(t,a){routesJSON=a;for(var n=0;n<routesJSON.routes.length;n++)routesArray[routesJSON.routes[n].id]=routesJSON.routes[n].route;mapDraw(e)})}).fail(function(){mapDraw(e)})});
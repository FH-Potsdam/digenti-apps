function OpenInNewTab(t){var e=window.open(t,"_blank");e.focus()}function showValue(){var t=$("#range__slider").val();document.getElementById("range").innerHTML=t+" minutes"}function mapDraw(t){function e(t,e){var a=document.getElementById("switch"),n=document.createElement("div");a.appendChild(n);var r=document.createElement("input");r.type="checkbox",r.id=e,r.checked=!0,n.appendChild(r);var o=document.createElement("label");o.setAttribute("for",e),o.textContent=t,n.appendChild(o),r.addEventListener("change",function(t){map.setLayoutProperty(e,"visibility",t.target.checked?"visible":"none")})}function a(t){"DIGENTI"==t?map.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"fos-outdoor"==t?map.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):map.setStyle("mapbox://styles/mapbox/"+t)}mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A",map=new mapboxgl.Map({container:"map",style:"mapbox://styles/jorditost/cipseaugm001ycunimvr00zea",zoom:11,center:[-73.02,10.41]}),map.addControl(new mapboxgl.Navigation),map.on("style.load",function(){$.each(map_data_sources,function(t,e){map.addSource(e[0],e[1])}),$.each(map_data_layers,function(t,e){map.addLayer(e)})});var n=map.getCanvasContainer();svg=d3.select(n).append("svg").attr("class","map-features"),featureElement=svg.append("g").attr("class","villages").selectAll("g").data(t.features).enter().append("g").attr("class","village-group").append("circle").attr({r:8}).attr("class","village").attr("data-id",function(){return generateUniqueID()}).on("click",function(t){d3.select(this).classed("selected",!0);var e=d3.select(this).attr("data-id")}),map.on("viewreset",update),map.on("movestart",function(){}),map.on("moveend",function(){update(0)}),update(0);var r=document.getElementById("basemap_select"),o=r.options;r.onchange=function(){var t=o[r.selectedIndex].value;a(t)}}function generateUniqueID(){return"id"+(new Date).getTime().toString()+Math.random().toString(36).substr(2,16)}function transformHEREgeometry(t){for(var e=0;e<t.length;e++){t[e]=t[e].split(",");for(var a=0;a<t[e].length;a++)t[e][a]=parseFloat(t[e][a]);var n=t[e][0];t[e][0]=t[e][1],t[e][1]=n}return t}function getIsoline(t,e,a){var n,r=parseInt($("#range__slider").val()),o=(1e3*r).toString();c="geo!"+t[1]+","+t[0];var i={mode:"fastest;car",resolution:"1",maxpoints:"1000",rangetype:"time",start:c,distance:o},s=function(o){var i=transformHEREgeometry(o.Response.isolines[0].value),s={type:"Feature",properties:{objectID:e},geometry:{type:"Polygon",coordinates:[i]}},c=turf.buffer(s,0,"meters"),l={type:"Feature",properties:{"marker-color":"#f00"},geometry:{type:"Point",coordinates:t}},p=turf.inside(l,c.features[0]);if(p){var u=[e+"-"+r,{type:"geojson",data:s}],d={id:"isoline_"+e+"-"+r,type:"fill",source:e+"-"+r,layout:{},paint:{"fill-color":"#088","fill-opacity":.1}};map_data_sources.push(u),map_data_layers.push(d),map.addSource(u[0],u[1]),map.addLayer(d),n={touches_street:!0,distance_to_street:0,nearest_point:t}}else{for(var m=[],f=0;f<i.length;f++)m.push(turf.point(i[f]));var y=turf.featurecollection(m),g=turf.nearest(l,street_points_aoi),_=turf.distance(l,g,"kilometers");n={touches_street:!1,distance_to_street:1e3*_,nearest_point:g.geometry.coordinates}}a.properties.connections=n,places_aoi_street_distance.features.push(a),places_aoi_street_distance.features.length===places_aoi.features.length&&(activateButtons(),places_aoi_street_distance.features.sort(function(t,e){return d3.ascending(t.properties.name,e.properties.name)}),svg.selectAll(".village").data(places_aoi_street_distance.features).attr("data-distance_to_street",function(t){return t.properties.connections.distance_to_street}).attr("data-touches_street",function(t){return t.properties.connections.touches_street}).enter(),svg.selectAll(".village-group").each(function(t,e){var a=d3.select(this);a.append("line"),a.append("circle").attr({r:4}).attr("class","road"),a.append("text").text(t.properties.name).style("font-weight","bold").attr("y","30"),a.append("text").text("Distance to Street: "+Math.round(t.properties.connections.distance_to_street)+" meter").attr("y","45")}),update(0))};enterpriseRouter.calculateIsoline(i,function(t){s(t)},function(t){alert(t.message)})}function update(t){if(w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),"smallmultiples"===view){for(var e=0,a=0,n=7,r=6,o=.8*w/(r+1),i=h/(n+1),s=[],c=0;c<places_aoi_street_distance.features.length;c++)s.push(places_aoi_street_distance.features[c].properties.connections.distance_to_street);var l=Math.max.apply(null,s),p=.8*o/(2*l);svg.selectAll(".village-group").each(function(s,c){var l=d3.select(this);l.transition().duration(t).style("opacity",1).attr("transform",function(t){var n=.2*w+e*o+o/2,r=a*i+i;return"translate("+n+","+r+")"}),l.select(".village").transition().duration(t).attr("cx",function(){var t=8;return s.properties.connections.distance_to_street>0&&(t=2*p*s.properties.connections.distance_to_street),t}),l.select(".road").transition().duration(t).style("opacity",1).attr("cy",0).attr("cx",function(){var t=8;return s.properties.connections.distance_to_street>0&&(t=0),t}),l.select("line").transition().duration(t).attr("x1",0).attr("y1",0).attr("x2",2*p*s.properties.connections.distance_to_street).attr("y2",0),l.selectAll("text").attr("x",0).transition().duration(500).style("opacity",1),setMapOpacity(0),e++,e===r&&(e=0),a++,a===n&&(a=0)})}else"map_distances"===view?svg.selectAll(".village-group").each(function(e,a){var n=d3.select(this),r=project(e.geometry.coordinates).x,o=project(e.geometry.coordinates).y,i=project(e.properties.connections.nearest_point).x-r,s=project(e.properties.connections.nearest_point).y-o;n.transition().duration(t).style("opacity",.4).attr("transform",function(t){return"translate("+r+","+o+")"}),n.select(".village").transition().duration(t).attr("cx",function(){return 0}),n.select(".road").transition().duration(t).style("opacity",1).attr("cx",i).attr("cy",s),n.select("line").transition().duration(t).attr("x1",0).attr("y1",0).attr("x2",i).attr("y2",s),n.selectAll("text").transition().duration(t).style("opacity",0),setMapOpacity(1)}):svg.selectAll(".village-group").each(function(e,a){var n=d3.select(this),r=project(e.geometry.coordinates).x,o=project(e.geometry.coordinates).y;n.transition().duration(t).style("opacity",.4).attr("transform",function(t){return"translate("+r+","+o+")"}),n.select(".village").transition().duration(t).attr("cx",function(){return 0}),n.select(".road").transition().duration(t).style("opacity",0),n.select("line").transition().duration(t).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0),n.selectAll("text").transition().duration(t).style("opacity",0),setMapOpacity(1)});console.log("UPDATE");for(var u=0;u<isolines_collection.length;u++)"undefined"!=typeof isolines_collection[u]&&isolines_collection[u].attr("points",function(t){for(var e=[],a=0;a<t.length;a++)e.push([project(t[a]).x,project(t[a]).y].join(","));return e.join(" ")})}function project(t){return map.project(new mapboxgl.LngLat(+t[0],+t[1]))}function isolineAll(){for(var t=0;t<places_aoi.features.length;t++){var e=places_aoi.features[t];getIsoline(e.geometry.coordinates,e.properties.osm_id,e)}}function triggerSmallMultiplesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".smallmultiplesview").classed("active",!0),view="smallmultiples",update(500)}function triggerMapView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapview").classed("active",!0),view="",update(500)}function triggerMapDistancesView(){d3.selectAll(".view").classed("active",!1),d3.selectAll(".mapdistancesview").classed("active",!0),view="map_distances",update(500)}function setMapOpacity(t){d3.selectAll(".mapboxgl-canvas").transition().duration(500).style("opacity",t),d3.selectAll(".mapboxgl-control-container").transition().duration(500).style("opacity",t)}function getGEOJSON(){var t=JSON.stringify(places_aoi_street_distance);OpenInNewTab("data:text/plain;charset=utf-8,"+encodeURIComponent(t))}function activateButtons(){d3.selectAll(".disabled").attr("disabled",null)}Array.prototype.equals&&console.warn("Overriding existing Array.prototype.equals. Possible causes: New API defines the method, there's a framework conflict or you've got double inclusions in your code."),Array.prototype.equals=function(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var e=0,a=this.length;a>e;e++)if(this[e]instanceof Array&&t[e]instanceof Array){if(!this[e].equals(t[e]))return!1}else if(this[e]!=t[e])return!1;return!0},Object.defineProperty(Array.prototype,"equals",{enumerable:!1});var platform=new H.service.Platform({app_id:"EOg7UyuSFbPF0IG5ANjz",app_code:"iRnqNl0dyzX_8FOlchD0ZQ"}),enterpriseRouter=platform.getEnterpriseRoutingService();showValue();var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),pathData,pathFootData,routes_collection=[],gRoutes,isoline,isolines_collection=[],map_data_sources=[],map_data_layers=[],map,featureElement,svg,view="",places_aoi,street_points_aoi,places_aoi_street_distance={type:"FeatureCollection",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:[]};d3.json("../../data/places_aoi.json",function(t,e){places_aoi=e,d3.json("../../data/street_points_aoi.json",function(t,e){street_points_aoi=e,mapDraw(places_aoi)})});
<!DOCTYPE html>
<html>

    <head>
        <meta charset=utf-8 />
        <title>Routing Test 01</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='../../lib/mapbox-gl.js'></script>
        <link href='../../lib/mapbox-gl.css' rel='stylesheet' />

        <!-- This example requires d3 for AJAX and the brush, though you can bring your own library. -->
        <script src='../../lib/d3.min.js' charset="utf-8"></script>
        <script src='../../lib/turf.min.js' charset='utf-8'></script>
        <script src='../../lib/polymorph.js' charset='utf-8'></script>
        <script src='../../lib/morphpath.js' charset='utf-8'></script>

        <style>

            #menu {
                position: absolute;
                background: #fff;
                padding: 10px;
                font-family: 'Futura', sans-serif;
                z-index: 3000;
            }

            html, body, #wrapper {
                width: 100%;
                height: 100%;
            	padding: 0px;
            	margin: 0px;
            }
            #map {
              position:relative;
              width: 100%;
              height: 100%;
              margin: auto auto;
            }
            svg {
              position: absolute;
              width: 100%;
              height: 100%;
            }
            .hidden {
            	display: none;
            }


        </style>
    </head>

    <body>
        <style>
        .ui-brush {
          background:#f8f8f8;
          position:absolute;
          bottom:0;right:0;left:0;
          height:100px;
          }
        .brush .extent {
          stroke:#fff;
          fill-opacity:0.125;
          shape-rendering:crispEdges;
          }
        </style>


        <div id='menu'>

            <label>Select Basemap</label>
            <select id="basemap_select">
                <option value="basic">basic</option>
                <option value="streets" selected>streets</option>
                <option value="emerald">emerald</option>
                <option value="bright">bright</option>
                <option value="light">light</option>
                <option value="dark">dark</option>
                <option value="satellite">satellite</option>
            </select>

            <label>Pitch</label>
            <select id="pitch_select">
                <option value="0">0</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
                <option value="40">40</option>
                <option value="50">50</option>
                <option value="60">60</option>
                <option value="70">70</option>
                <option value="80">80</option>
                <option value="90">90</option>
            </select>

            <label>Bearing</label>
            <select id="bearing_select">
                <option value="0">0</option>
                <option value="45">45</option>
                <option value="90">90</option>
                <option value="135">135</option>
                <option value="180">180</option>
                <option value="225">225</option>
                <option value="270">270</option>
                <option value="315">315</option>
                <option value="360">360</option>
            </select>

        </div>

    <div id='map' class='dark'></div>

        <script>
            /*L.mapbox.accessToken = 'pk.eyJ1IjoiZmFiaWFuZWhtZWwiLCJhIjoiNDZiNTI3NGQxNzRiNjgxMGEwYTljYjgzZDU5ZjdjODYifQ.Mu_TWKlvON7j4UAkQ1EXJg';
            var map = L.mapbox.map('map', 'mapbox.satellite')
                .setView([0, 0], 1);*/

            d3.json("places_aoi.json", function(err, data) {
                mapDraw(data);
            });

            var currentBearing = 0;
            var currentPitch = 0;
            var routes_points = [];
            var routes_paths = [];
            var routing_history = [];
            var pathData;

            //mapDraw("geojson");

            function mapDraw(geojson) {

                mapboxgl.accessToken = 'pk.eyJ1IjoiZmFiaWFuZWhtZWwiLCJhIjoiNDZiNTI3NGQxNzRiNjgxMGEwYTljYjgzZDU5ZjdjODYifQ.Mu_TWKlvON7j4UAkQ1EXJg';

                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v8',
                    zoom: 11,
                    center: [-73.02, 10.410],
                    pitch: currentPitch, // pitch in degrees
                    bearing: currentBearing // bearing in degrees

                });


                map.addControl(new mapboxgl.Navigation());

                // MapboxGL container
                var container = map.getCanvasContainer()

                // d3 canvas
                var svg = d3.select(container).append("svg")

             	var featureElement = svg
                    .append("g")
                        .attr("class", "villages")
                        .selectAll("circle")
                		.data(geojson.features)
                		.enter()
                		.append("svg:circle")
                    		.attr({
                                "r": 8,
                    			"stroke": "none",
                    			"fill": "#f00",
                    			"fill-opacity": 0.4
                    		})
                            .on("click", click);

                //This is the accessor function we talked about above
                var lineFunction = d3.svg.line()
                                    .x(function(d) { return project(d).x; })
                                    .y(function(d) { return project(d).y; })
                                    .interpolate("linear");


                // This callback is called when clicking on a location
                function click(d) {

                    var coordinates = d.geometry.coordinates;
                    routing_history.push(coordinates[1]+","+coordinates[0]);

                    if (routing_history.length > 1) {

                        var api_request = "https://graphhopper.com/api/1/route?point="+routing_history[routing_history.length-2]+"&point="+routing_history[routing_history.length-1]+"&type=json&key=af189539-9363-4c60-b6af-f6b86294d181&locale=de-DE&vehicle=car&weighting=fastest&elevation=true&points_encoded=false&debug=true";

                        d3.json(api_request, function(error,response) {

                            pathData = response.paths[0].points.coordinates;

                            console.log(pathData);

                            var lineGraph = svg.append("path")
                                .attr("d", lineFunction(pathData))
                                .attr("stroke", "blue")
                                .attr("stroke-width", 1)
                                .attr("fill", "none");

                                setTimeout(function() {
                                    console.log("transform");
                                    var line = morphpath.linify(lineGraph.attr("d"));

                                    lineGraph
                                        .transition()
                                        .duration(2000)
                                        .attr("d", line);

                                }, 1000);

                            routes_paths.push(lineGraph);

                            var temp = svg
                                .append("g")
                                    .attr("class", "routes")
                                    .selectAll("circle")
                                    .data(pathData)
                                    .enter()
                                    .append("svg:circle")
                                        .attr({
                                            "r": 2,
                                            "fill": "blue",
                                            "fill-opacity": 0.4
                                        });

                            routes_points.push(temp);

                            update();
                        });

                    }




                }


                var cmdPressed = false;
                var mouseX_start;

                window.onmousedown = function (e) {

                    window.onmousemove = function (e) {
                        if (!e) e = window.event;
                        if (e.metaKey) {
                            if (!cmdPressed) {
                                mouseX_start = e.clientX;
                            }
                            cmdPressed = true;
                            console.log(mouseX_start - e.clientX);
                            currentBearing = currentBearing - (mouseX_start - e.clientX)*0.02;
                            flyMap();
                        }
                    }

                }


                function update() {

                    for (var i = 0; i < routes_paths.length; i++) {
                        routes_paths[i]
                            .attr("d", lineFunction(pathData));
                    }

                    for (var i = 0; i < routes_points.length; i++) {
                        routes_points[i]
                            .attr({
                                cx: function(d) { return project(d).x; },
                                cy: function(d) { return project(d).y; },
                            });
                    }

                    featureElement
                        .attr({
                            cx: function(d) { return project(d.geometry.coordinates).x; },
                            cy: function(d) { return project(d.geometry.coordinates).y; },
                        });
                }

                //
                map.on("viewreset", update);

                map.on("movestart", function() {
            		svg.classed("hidden", true);
            	});

                map.on("rotate", function() {
            		svg.classed("hidden", true);
            	});

                map.on("moveend", function() {
            		update();
            		svg.classed("hidden", false);
            	});

                //初期レンダリング
                update();

                // Use MapboxGL projection for d3 features
                function project(d) {
                    return map.project(new mapboxgl.LngLat(+d[0], +d[1]));
                }


                var basemap_select = document.getElementById('basemap_select');
                var basemap_select_options = basemap_select.options;

                basemap_select.onchange = function() {
                    var selectedValue = basemap_select_options[basemap_select.selectedIndex].value;
                    switchLayer(selectedValue);
                }

                function switchLayer(layer) {
                    map.setStyle('mapbox://styles/mapbox/' + layer + '-v8');
                }


                var pitch_select = document.getElementById('pitch_select');
                var pitch_select_options = pitch_select.options;

                pitch_select.onchange = function() {
                    var selectedValue = pitch_select_options[pitch_select.selectedIndex].value;
                    switchPitch(parseFloat(selectedValue));
                }

                function switchPitch(value) {
                    currentPitch = value;
                    flyMap();
                }


                var bearing_select = document.getElementById('bearing_select');
                var bearing_select_options = bearing_select.options;

                bearing_select.onchange = function() {
                    var selectedValue = bearing_select_options[bearing_select.selectedIndex].value;
                    switchBearing(parseFloat(selectedValue));
                }

                function switchBearing(value) {
                    currentBearing = value;
                    flyMap();
                }

                function flyMap() {
                    map.flyTo({
                        // These options control the ending camera position: centered at
                        // the target, at zoom level 9, and north up.
                        bearing: currentBearing,
                        pitch: currentPitch,

                        // These options control the flight curve, making it move
                        // slowly and zoom out almost completely before starting
                        // to pan.
                        speed: 1, // make the flying slow
                        curve: 1, // change the speed at which it zooms out

                        // This can be any easing function: it takes a number between
                        // 0 and 1 and returns another number between 0 and 1.
                        easing: function (t) {
                            return t;
                        }
                    });
                }
            }

            ////////////////
            // Math Utils
            ////////////////

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }

        </script>
    </body>
</html>

function showValue(){var t=$("#range__slider").val();document.getElementById("range").innerHTML=t+" minutes"}function isolineAll(){$(".village").each(function(t){console.log("asdasd"),$(this).d3Click()})}function mapDraw(t){function e(){p.addSource("colombia-fos",{type:"vector",url:"mapbox://jorditost.49a7b9e1"}),p.addLayer({id:"fos3",type:"line",source:"colombia-fos","source-layer":"colombia_fos_h1_m0_5_CLASSIFIED_wgs84",filter:["==","elev",3],layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#e6dc51","line-width":2,"line-opacity":.3}}),p.addLayer({id:"fos2",type:"line",source:"colombia-fos","source-layer":"colombia_fos_h1_m0_5_CLASSIFIED_wgs84",filter:["==","elev",2],layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#d9943f","line-width":2,"line-opacity":.3}}),p.addLayer({id:"fos1",type:"line",source:"colombia-fos","source-layer":"colombia_fos_h1_m0_5_CLASSIFIED_wgs84",filter:["==","elev",1],layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#c74d4d","line-width":2,"line-opacity":.3}}),n("FOS 1","fos1"),n("FOS 2","fos2"),n("FOS 3","fos3")}function o(){p.addSource("colombia-upstream-areas",{type:"vector",url:"mapbox://jorditost.4ljeh60j"}),p.addLayer({id:"colombia-upstream-areas",type:"fill",source:"colombia-upstream-areas","source-layer":"upstream_areas_aoi",paint:{"fill-color":"#4f91ab","fill-opacity":.2}}),n("Upstream Areas","colombia-upstream-areas")}function n(t,e){var o=document.getElementById("switch"),n=document.createElement("div");o.appendChild(n);var r=document.createElement("input");r.type="checkbox",r.id=e,r.checked=!0,n.appendChild(r);var a=document.createElement("label");a.setAttribute("for",e),a.textContent=t,n.appendChild(a),r.addEventListener("change",function(t){p.setLayoutProperty(e,"visibility",t.target.checked?"visible":"none")})}function r(t,e){var o=t.geometry.coordinates;console.log(t),routing_history.push(o[1]+","+o[0]),"routing"===currentMode&&routing_history.length>1&&i(o),"isoline"===currentMode&&a(o,e)}function a(t,e){console.log(t);var o=parseInt($("#range__slider").val()),n=(1e3*o).toString();console.log(n),c="geo!"+t[1]+","+t[0];var r={mode:"fastest;car",resolution:"1",maxpoints:"1000",rangetype:"time",start:c,distance:n};console.log(c);var a=function(o){console.log(o);var n=o.Response.isolines[0].value;n=transformHEREgeometry(n),console.log(n);var r={type:"Feature",properties:{objectID:e},geometry:{type:"Polygon",coordinates:[n]}},a={type:"Feature",properties:{"marker-color":"#f00"},geometry:{type:"Point",coordinates:t}},i=turf.buffer(r,500,"meters");console.log(i);var s=turf.inside(a,i.features[0]);console.log(s),s&&(p.addSource(e,{type:"geojson",data:r}),p.addLayer({id:"isoline_"+e,type:"fill",source:e,layout:{},paint:{"fill-color":"#088","fill-opacity":.1}}))};enterpriseRouter.calculateIsoline(r,a,function(t){alert(t.message)})}function i(t){function e(t){console.log(t)}function o(t){var e=t.response,o={init:function(){return this.id=generateUniqueID(),this.geometry=transformHEREgeometry(e.route[0].shape),this.travelTime=e.route[0].summary.travelTime,this.path=lineFunction(this.geometry),this}}.init();routes_collection.push(o);var n=gRoutes.append("path").attr("class","route").attr("d",o.path).attr("stroke-width",2);routes_paths.push(n),compareRouteWithCollection(o,routes_collection),setTimeout(function(){var t=g.append("path").attr("class","distance").attr("d",o.path).attr("stroke-width",4),e=morphpath.linify(o.path,0,10,.85*window.innerHeight+10+lines_paths.length*linePadding);t.transition().duration(2e3).attr("d",e);var n=g.append("path").attr("class","time").attr("d",o.path).attr("stroke-width",4),r=morphpath.linify(o.path,0,10,.85*window.innerHeight+10+lines_paths.length*linePadding,parseInt(o.travelTime));n.transition().duration(2e3).attr("transform","translate(0,5)").attr("d",r),lines_paths.push(e)},1e3),s()}var n={mode:"fastest;car",representation:"display",routeattributes:"waypoints,summary,shape,legs",maneuverattributes:"direction,action",waypoint0:routing_history[routing_history.length-2],waypoint1:routing_history[routing_history.length-1],returnelevation:"true"};router.calculateRoute(n,o,e)}function s(){for(var t=0;t<routes_paths.length;t++)routes_paths[t].attr("d",lineFunction(pathData));for(var t=0;t<routes_points.length;t++)routes_points[t].attr({cx:function(t){return l(t).x},cy:function(t){return l(t).y}});for(var t=0;t<routes_foot_paths.length;t++)routes_foot_paths[t].attr("d",lineFunction(pathFootData));for(var t=0;t<routes_foot_points.length;t++)routes_foot_points[t].attr({cx:function(t){return l(t).x},cy:function(t){return l(t).y}});m.attr({cx:function(t){return l(t.geometry.coordinates).x},cy:function(t){return l(t.geometry.coordinates).y}}),console.log("UPDATE");for(var e=0;e<isolines_collection.length;e++)"undefined"!=typeof isolines_collection[e]&&isolines_collection[e].attr("points",function(t){for(var e=[],o=0;o<t.length;o++)e.push([l(t[o]).x,l(t[o]).y].join(","));return e.join(" ")})}function l(t){return p.project(new mapboxgl.LngLat(+t[0],+t[1]))}function u(t){"DIGENTI"==t?p.setStyle("mapbox://styles/jorditost/cipseaugm001ycunimvr00zea"):"fos-outdoor"==t?p.setStyle("mapbox://styles/jorditost/cip44ooh90013cjnkmwmwd2ft"):p.setStyle("mapbox://styles/mapbox/"+t),p.on("load",function(){e()})}mapboxgl.accessToken="pk.eyJ1Ijoiam9yZGl0b3N0IiwiYSI6ImQtcVkyclEifQ.vwKrOGZoZSj3N-9MB6FF_A";var p=new mapboxgl.Map({container:"map",style:"mapbox://styles/jorditost/cipseaugm001ycunimvr00zea",zoom:11,center:[-73.02,10.41]});p.addControl(new mapboxgl.Navigation),p.on("load",function(){e(),o()});var d=p.getCanvasContainer(),f=d3.select(d).append("svg").attr("class","map-morphed"),h=d3.select(d).append("svg").attr("class","map-features");gRoutes=h.append("g").attr("class","routes");var g=f.append("g").attr("class","route-lines");isolinesGroup=h.append("g").attr("class","isolinesGroup");var m=h.append("g").attr("class","villages").selectAll("circle").data(t.features).enter().append("circle").attr({r:8}).attr("class","village").attr("data-id",function(){return generateUniqueID()}).on("click",function(t){d3.select(this).classed("selected",!0);var e=d3.select(this).attr("data-id");r(t,e)});lineFunction=d3.svg.line().x(function(t){return l(t).x}).y(function(t){return l(t).y}).interpolate("linear"),p.on("viewreset",s),p.on("movestart",function(){}),p.on("moveend",function(){s()}),s();var y=document.getElementById("basemap_select"),v=y.options;y.onchange=function(){var t=v[y.selectedIndex].value;u(t)}}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t))+t}function generateUniqueID(){return"id"+(new Date).getTime().toString()+Math.random().toString(36).substr(2,16)}function transformHEREgeometry(t){for(var e=0;e<t.length;e++){t[e]=t[e].split(",");for(var o=0;o<t[e].length;o++)t[e][o]=parseFloat(t[e][o]);var n=t[e][0];t[e][0]=t[e][1],t[e][1]=n}return t}function getOverlappingGeometry(t,e){for(var o=[],n=0;n<t.length;n++)for(var r=0;r<e.length;r++)t[n].equals(e[r])&&o.push(t[n]);return o}function compareRouteWithCollection(t,e){if(e.length>1)for(var o=0;o<e.length;o++)if(t.id!==e[o].id){var n=getOverlappingGeometry(t.geometry,e[o].geometry);if(n.length>0){var r=gRoutes.append("path").attr("class","route").attr("d",lineFunction(n)).attr("stroke-width",8);routes_paths.push(r)}}}function setMode(t){d3.selectAll("button.mode").classed("active",!1),currentMode=t,d3.select("."+t).classed("active",!0)}var platform=new H.service.Platform({app_id:"EOg7UyuSFbPF0IG5ANjz",app_code:"iRnqNl0dyzX_8FOlchD0ZQ"}),router=platform.getRoutingService(),enterpriseRouter=platform.getEnterpriseRoutingService();showValue(),$.fn.d3Click=function(){this.each(function(t,e){var o=new MouseEvent("click");e.dispatchEvent(o)})};var linePadding=15;d3.json("../../data/places_aoi.json",function(t,e){mapDraw(e)});var routes_points=[],routes_paths=[],lines_paths=[],routes_foot_points=[],routes_foot_paths=[],routing_history=[],pathData,pathFootData,routes_collection=[],gRoutes,lineFunction,currentMode,isoline,isolines_collection=[],isolinesGroup;Array.prototype.equals&&console.warn("Overriding existing Array.prototype.equals. Possible causes: New API defines the method, there's a framework conflict or you've got double inclusions in your code."),Array.prototype.equals=function(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var e=0,o=this.length;o>e;e++)if(this[e]instanceof Array&&t[e]instanceof Array){if(!this[e].equals(t[e]))return!1}else if(this[e]!=t[e])return!1;return!0},Object.defineProperty(Array.prototype,"equals",{enumerable:!1});